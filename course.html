<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>محتوى الكورس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <style> 
    body { font-family: 'Tajawal', sans-serif; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto">
    <div id="loader" class="loader"></div>
    <div id="courseInfo" class="bg-white p-6 rounded-xl shadow mb-6 hidden"></div>
    <div id="contentContainer" class="space-y-6"></div>
    <p id="statusMsg" class="text-center text-red-600 font-semibold hidden mt-10"></p>
    <div id="debugInfo" class="mt-6 p-4 bg-gray-200 rounded-lg hidden"></div>
  </div>

  <script>
    // Firebase Init
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    });

    const db = firebase.firestore();
    const auth = firebase.auth();

    const contentDiv = document.getElementById("contentContainer");
    const statusMsg = document.getElementById("statusMsg");
    const courseInfo = document.getElementById("courseInfo");
    const loader = document.getElementById("loader");
    const debugInfo = document.getElementById("debugInfo");
    const courseId = new URLSearchParams(window.location.search).get("courseId");

    // إظهار معلومات التصحيح للمطور
    function showDebugInfo(info) {
      debugInfo.classList.remove("hidden");
      debugInfo.innerHTML = `<h3 class="font-bold mb-2">معلومات التصحيح:</h3><pre>${JSON.stringify(info, null, 2)}</pre>`;
    }

    auth.onAuthStateChanged(async (user) => {
      try {
        if (!user) {
          console.log("No user found, redirecting...");
          window.location.href = "index.html";
          return;
        }

        console.log("User authenticated:", user.uid);
        
        const userDoc = await db.collection("students").doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.log("Student document not found");
          statusMsg.textContent = "❌ حساب الطالب غير موجود!";
          statusMsg.classList.remove("hidden");
          loader.classList.add("hidden");
          return;
        }

        const student = userDoc.data();
        console.log("Student data:", student);
        
        // عرض معلومات التصحيح
        showDebugInfo({
          userId: user.uid,
          courseId: courseId,
          enrolledCourses: student.enrolledCourses,
          isEnrolled: student.enrolledCourses && student.enrolledCourses.includes(courseId)
        });

        if (!student.enrolledCourses || !student.enrolledCourses.includes(courseId)) {
          console.log("Student not enrolled in this course");
          statusMsg.textContent = "❌ أنت غير مسجل في هذا الكورس!";
          statusMsg.classList.remove("hidden");
          loader.classList.add("hidden");
          return;
        }

        // كل شيء جيد، تحميل المحتوى
        await showCourseInfo();
        await loadLectures();
        loader.classList.add("hidden");
        
      } catch (error) {
        console.error("Authentication error:", error);
        statusMsg.textContent = "❌ حدث خطأ أثناء تحميل البيانات. الرجاء المحاولة لاحقًا.";
        statusMsg.classList.remove("hidden");
        loader.classList.add("hidden");
      }
    });

    async function showCourseInfo() {
      try {
        const courseDoc = await db.collection("courses").doc(courseId).get();
        
        if (!courseDoc.exists) {
          console.log("Course not found");
          statusMsg.textContent = "❌ الكورس المطلوب غير موجود!";
          statusMsg.classList.remove("hidden");
          return;
        }

        const course = courseDoc.data();
        courseInfo.classList.remove("hidden");
        courseInfo.innerHTML = `
          <div class="flex items-center gap-6">
            <img src="${course.imageURL || 'https://via.placeholder.com/160x112'}" 
                 class="w-40 h-28 object-cover rounded-xl border" />
            <div>
              <h1 class="text-2xl font-bold text-indigo-700">${course.name}</h1>
              <p class="text-gray-700 mt-2">${course.description || 'لا يوجد وصف متاح'}</p>
              <p class="text-sm text-gray-500 mt-2">معرف الكورس: ${courseId}</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error("Error loading course info:", error);
        statusMsg.textContent = "❌ حدث خطأ أثناء تحميل معلومات الكورس.";
        statusMsg.classList.remove("hidden");
      }
    }

    async function loadLectures() {
      try {
        const lecturesSnapshot = await db.collection("lectures")
          .where("courseId", "==", courseId)
          .orderBy("createdAt")
          .get();

        console.log(`Found ${lecturesSnapshot.size} lectures for course ${courseId}`);

        if (lecturesSnapshot.empty) {
          contentDiv.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow text-center">
              <p class="text-gray-500">لا يوجد محاضرات متاحة بعد.</p>
              <p class="text-sm text-gray-400 mt-2">سيتم إضافة المحاضرات قريبًا</p>
            </div>
          `;
          return;
        }

        let hasContent = false;

        for (const doc of lecturesSnapshot.docs) {
          const lecture = doc.data();
          const section = document.createElement("div");
          section.className = "bg-white p-4 rounded-xl shadow";

          const toggleId = `toggle_${lecture.id}`;
          section.innerHTML = `
            <button class="w-full text-right font-bold text-lg text-indigo-700 flex justify-between items-center" 
                    onclick="toggleContent('${toggleId}')">
              <span>📘 ${lecture.lectureTitle || 'محاضرة بدون عنوان'}</span>
              <span class="text-gray-500 text-sm">${new Date(lecture.createdAt?.toDate()).toLocaleDateString()}</span>
            </button>
            <div id="${toggleId}" class="mt-4 space-y-4 hidden"></div>
          `;

          contentDiv.appendChild(section);

          const contentsSnapshot = await db.collection("lectureContent")
            .where("lectureId", "==", lecture.id)
            .orderBy("createdAt")
            .get();

          const inner = section.querySelector(`#${toggleId}`);

          if (contentsSnapshot.empty) {
            inner.innerHTML = `<p class="text-gray-400 p-4">لا يوجد محتوى لهذه المحاضرة بعد.</p>`;
          } else {
            hasContent = true;
            contentsSnapshot.forEach(contentDoc => {
              const content = contentDoc.data();
              let button = "";

              if (content.type === "video") {
                button = `<a href="watch-video.html?url=${encodeURIComponent(content.url)}"
                            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 inline-block">
                            🎬 اضغط للمشاهدة</a>`;
              } else if (content.type === "pdf") {
                button = `<a href="${content.url}" target="_blank"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 inline-block">
                            📄 تحميل PDF</a>`;
              } else if (content.type === "quiz") {
                button = `<a href="start-quiz.html?id=${contentDoc.id}"
                            class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 inline-block">
                            📝 بدء الاختبار</a>`;
              }

              inner.innerHTML += `
                <div class="border p-4 bg-gray-50 rounded-lg">
                  <h3 class="font-medium text-gray-800 mb-2">${content.title || 'عنوان غير محدد'}</h3>
                  <p class="text-sm text-gray-500 mb-3">${content.description || ''}</p>
                  ${button}
                </div>
              `;
            });
          }
        }

        if (!hasContent) {
          statusMsg.textContent = "⚠️ تم تحميل العناوين ولكن لا يوجد محتوى متاح بعد.";
          statusMsg.classList.remove("hidden");
        }

      } catch (err) {
        console.error("Error loading lectures:", err);
        statusMsg.textContent = "❌ حدث خطأ أثناء تحميل المحاضرات. الرجاء تحديث الصفحة أو المحاولة لاحقًا.";
        statusMsg.classList.remove("hidden");
      }
    }

    function toggleContent(id) {
      const section = document.getElementById(id);
      section.classList.toggle("hidden");
    }
  </script>
</body>
</html>
