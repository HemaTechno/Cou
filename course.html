<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>محتوى الكورس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style> body { font-family: 'Tajawal', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-center text-indigo-700 mb-6">📚 محتوى الكورس</h2>
    <div id="contentArea" class="space-y-6"></div>
  </div>

  <script>
    // Firebase init
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    });

    const db = firebase.firestore();
    const auth = firebase.auth();
    const courseId = new URLSearchParams(window.location.search).get("id");
    const contentArea = document.getElementById("contentArea");

    // التحقق من تسجيل الدخول وامتلاك الكورس
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("يرجى تسجيل الدخول أولاً");
        window.location.href = "login.html";
        return;
      }

      try {
        const studentDoc = await db.collection("students").doc(user.uid).get();
        if (!studentDoc.exists) {
          alert("لم يتم العثور على بيانات الطالب");
          return;
        }

        const student = studentDoc.data();
        const enrolled = student.enrolledCourses || [];

        if (!enrolled.includes(courseId)) {
          alert("🚫 لم تقم بشراء هذا الكورس");
          return;
        }

        // تحميل المحاضرات المرتبطة بالكورس
        const lecturesSnap = await db.collection("lectures")
          .where("courseId", "==", courseId).get();

        if (lecturesSnap.empty) {
          contentArea.innerHTML = "<p class='text-center text-gray-500'>لا توجد محاضرات حالياً.</p>";
          return;
        }

        for (const doc of lecturesSnap.docs) {
          const lecture = doc.data();
          const lectureId = lecture.id;
          const title = lecture.lectureTitle;

          // محتوى المحاضرة
          const contentSnap = await db.collection("lectureContent")
            .where("lectureId", "==", lectureId).get();

          let lectureBlock = `
            <div class="bg-gray-50 border rounded-lg p-4">
              <h3 class="text-xl font-semibold text-indigo-800 mb-3">${title}</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          `;

          contentSnap.forEach(contentDoc => {
            const content = contentDoc.data();
            const button =
              content.type === "video"
                ? `<a href="watch.html?url=${encodeURIComponent(content.url)}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">🎬 اضغط للمشاهدة</a>`
              : content.type === "pdf"
                ? `<a href="${content.url}" download class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 block text-center">📄 تحميل PDF</a>`
              : `<a href="quiz.html?contentId=${contentDoc.id}" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 block text-center">📝 بدء الاختبار</a>`;

            lectureBlock += `
              <div class="bg-white p-4 border rounded shadow">
                <h4 class="font-medium mb-2">${content.title}</h4>
                ${button}
              </div>
            `;
          });

          lectureBlock += `</div></div>`;
          contentArea.innerHTML += lectureBlock;
        }

      } catch (err) {
        console.error(err);
        alert("❌ حدث خطأ أثناء تحميل المحتوى");
      }
    });
  </script>
</body>
</html>
