<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تسجيل الدخول | منصة عبدالرحمن السقا</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Tajawal', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#c4b5fd',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#5b21b6',
              900: '#4c1d95',
            },
            dark: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
            }
          }
        }
      }
    }
  </script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  
  <!-- Custom Styles -->
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      --glass-effect: rgba(255, 255, 255, 0.1);
    }
    
    body {
      background: url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5);
    }
    
    .btn-social {
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .btn-social:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .input-field {
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .input-field:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      background: white;
    }
    
    .file-upload {
      position: relative;
      overflow: hidden;
      border: 2px dashed rgba(139, 92, 246, 0.3);
      background: rgba(255, 255, 255, 0.6);
    }
    
    .file-upload:hover {
      border-color: #8b5cf6;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .file-upload-input {
      position: absolute;
      top: 0;
      right: 0;
      margin: 0;
      padding: 0;
      font-size: 20px;
      cursor: pointer;
      opacity: 0;
    }
    
    .animate-bounce-in {
      animation: bounceIn 0.6s ease;
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.9); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .pulse-effect {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 py-8 font-sans">

  <div class="glass-card p-8 max-w-xl w-full animate-bounce-in">
    <!-- Logo Header -->
    <div class="text-center mb-8">
      <div class="w-24 h-24 bg-gradient-to-r from-primary-600 to-primary-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
        <i class="fas fa-user-graduate text-white text-3xl"></i>
      </div>
      <h1 class="text-4xl font-extrabold text-gray-900 mb-2">مرحباً بك في</h1>
      <h2 class="text-3xl font-bold bg-gradient-to-r from-primary-600 to-primary-800 bg-clip-text text-transparent">منصة عبدالرحمن السقا</h2>
      <p class="text-gray-600 mt-3">سجل دخولك لبدء رحلتك التعليمية</p>
    </div>

    <!-- Social Login Buttons -->
    <div class="space-y-4 mb-6">
      <button id="googleLogin" class="btn-social w-full bg-white text-gray-800 font-semibold py-3 rounded-xl flex items-center justify-center gap-3">
        <i class="fab fa-google text-red-500 text-xl"></i>
        <span>المتابعة بحساب جوجل</span>
      </button>
      
      <button id="appleLogin" class="btn-social w-full bg-gray-900 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-3">
        <i class="fab fa-apple text-white text-xl"></i>
        <span>المتابعة بحساب Apple</span>
      </button>
    </div>

    <!-- Divider -->
    <div class="relative flex items-center justify-center my-6">
      <div class="border-t border-gray-200 w-full"></div>
      <span class="absolute bg-white px-4 text-gray-500 text-sm">أو</span>
    </div>

    <!-- Registration Form -->
    <form id="registerForm" class="space-y-5 hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="fullName" class="block text-right text-gray-700 mb-2 font-medium">الاسم الكامل</label>
          <input type="text" id="fullName" required placeholder="أدخل اسمك الكامل" 
                 class="input-field w-full px-4 py-3 rounded-xl text-right focus:outline-none" />
        </div>
        <div>
          <label for="studentNumber" class="block text-right text-gray-700 mb-2 font-medium">رقم الطالب</label>
          <input type="text" id="studentNumber" required placeholder="رقم الطالب" 
                 class="input-field w-full px-4 py-3 rounded-xl text-right focus:outline-none" />
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="fatherNumber" class="block text-right text-gray-700 mb-2 font-medium">رقم ولي الأمر</label>
          <input type="text" id="fatherNumber" required placeholder="رقم الأب" 
                 class="input-field w-full px-4 py-3 rounded-xl text-right focus:outline-none" />
        </div>
        <div>
          <label for="motherNumber" class="block text-right text-gray-700 mb-2 font-medium">رقم الأم</label>
          <input type="text" id="motherNumber" required placeholder="رقم الأم" 
                 class="input-field w-full px-4 py-3 rounded-xl text-right focus:outline-none" />
        </div>
      </div>
      
      <div>
        <label for="password" class="block text-right text-gray-700 mb-2 font-medium">كلمة المرور</label>
        <input type="password" id="password" required placeholder="كلمة المرور" 
               class="input-field w-full px-4 py-3 rounded-xl text-right focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-right text-gray-700 mb-2 font-medium">الصورة الشخصية</label>
        <div class="file-upload rounded-xl p-4 text-center">
          <input type="file" id="selfie" required accept="image/*" class="file-upload-input" />
          <label for="selfie" class="cursor-pointer">
            <i class="fas fa-cloud-upload-alt text-primary-600 text-3xl mb-2"></i>
            <p class="text-gray-700 font-medium">اسحب وأفلت الصورة هنا أو انقر للاختيار</p>
            <p class="text-sm text-gray-500 mt-1">يجب أن تكون الصورة واضحة وحديثة</p>
          </label>
        </div>
      </div>
      
      <button type="submit" class="btn-primary w-full text-white font-semibold py-3 rounded-xl mt-2 flex items-center justify-center gap-2">
        <i class="fas fa-paper-plane"></i>
        <span>إتمام التسجيل</span>
      </button>
    </form>

    <!-- Success Message -->
    <div id="successMsg" class="p-6 bg-green-50 border border-green-200 rounded-xl text-center hidden pulse-effect">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check-circle text-green-600 text-3xl"></i>
      </div>
      <h3 class="text-xl font-bold text-green-800 mb-2">تم التسجيل بنجاح!</h3>
      <p class="text-green-600">سيتم مراجعة طلبك خلال 48 ساعة وسيتم إعلامك عبر البريد الإلكتروني</p>
    </div>
    
    <!-- Footer -->
    <div class="mt-8 pt-5 border-t border-gray-200 text-center">
      <p class="text-gray-600 text-sm">بالنقر على "المتابعة" فإنك توافق على <a href="#" class="text-primary-600 hover:underline">الشروط والأحكام</a> و<a href="#" class="text-primary-600 hover:underline">سياسة الخصوصية</a></p>
    </div>
  </div>

  <!-- Firebase Config -->
  <script>
    // تأكد من استبدال هذه القيم بتفاصيل مشروع Firebase الخاص بك
    const firebaseConfig = {
  apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
  authDomain: "hhhhhh-d4fb8.firebaseapp.com",
  projectId: "hhhhhh-d4fb8",
  storageBucket: "hhhhhh-d4fb8.appspot.com",
  messagingSenderId: "24512338206",
  appId: "1:24512338206:web:dfe045db59bd3434a2110f",
  measurementId: "G-HD4R7GNQ5H"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
  </script>

  <!-- Submit Logic -->
  <script>
    const googleBtn = document.getElementById("googleLogin");
    const appleBtn = document.getElementById("appleLogin");
    const form = document.getElementById("registerForm");
    const successMsg = document.getElementById("successMsg");

    async function handleLogin(provider) {
      const originalBtnText = event.target.innerHTML;
      event.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';
      event.target.disabled = true;
      
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // تحقق مما إذا كان المستخدم موجودًا في Firestore
        const userDoc = await db.collection("students").doc(user.uid).get();
        
        if (userDoc.exists && userDoc.data().status) {
          // الحساب موجود ومكتمل
          successMsg.innerHTML = `
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-check-circle text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-green-800 mb-2">مرحباً بعودتك!</h3>
            <p class="text-green-600">حسابك مسجل مسبقاً، سيتم تحويلك إلى لوحة التحكم</p>
          `;
          form.classList.add("hidden");
          successMsg.classList.remove("hidden");
          
          // توجيه المستخدم إلى لوحة التحكم بعد 3 ثواني
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 3000);
        } else {
          // الحساب غير موجود أو غير مكتمل
          form.classList.remove("hidden");
          if (user.displayName) {
            document.getElementById("fullName").value = user.displayName;
          }
          if (user.email) {
            // يمكنك تعبئة الحقول الأخرى إذا لزم الأمر
          }
        }
      } catch (error) {
        console.error("حدث خطأ أثناء تسجيل الدخول:", error);
        
        // عرض رسالة الخطأ للمستخدم
        let errorMessage = "حدث خطأ أثناء تسجيل الدخول";
        if (error.code === 'auth/popup-closed-by-user') {
          errorMessage = "تم إغلاق نافذة التسجيل من قبل المستخدم";
        } else if (error.code === 'auth/account-exists-with-different-credential') {
          errorMessage = "هذا الحساب مسجل بالفعل بطريقة تسجيل مختلفة";
        }
        
        alert(errorMessage);
      } finally {
        // إعادة تعيين حالة الزر
        event.target.innerHTML = originalBtnText;
        event.target.disabled = false;
      }
    }

    // معالجة تسجيل الدخول بحساب جوجل
    googleBtn.addEventListener("click", (event) => {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      handleLogin(provider);
    });

    // معالجة تسجيل الدخول بحساب Apple
    appleBtn.addEventListener("click", (event) => {
      const provider = new firebase.auth.OAuthProvider('apple.com');
      provider.addScope('email');
      provider.addScope('name');
      handleLogin(provider);
    });

    // معالجة تقديم النموذج
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التسجيل...';
      submitBtn.disabled = true;
      
      const user = auth.currentUser;
      if (!user) {
        alert("يرجى تسجيل الدخول أولاً");
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        return;
      }

      try {
        // جمع بيانات النموذج
        const fullName = document.getElementById("fullName").value.trim();
        const studentNumber = document.getElementById("studentNumber").value.trim();
        const fatherNumber = document.getElementById("fatherNumber").value.trim();
        const motherNumber = document.getElementById("motherNumber").value.trim();
        const password = document.getElementById("password").value.trim();
        const selfieFile = document.getElementById("selfie").files[0];

        // التحقق من صحة البيانات
        if (!fullName || !studentNumber || !fatherNumber || !motherNumber || !password || !selfieFile) {
          throw new Error("الرجاء ملء جميع الحقول المطلوبة");
        }

        // رفع الصورة إلى Firebase Storage
        const storageRef = storage.ref().child(`students/${user.uid}/selfie.jpg`);
        const uploadTask = await storageRef.put(selfieFile);
        const selfieURL = await uploadTask.ref.getDownloadURL();

        // حفظ بيانات المستخدم في Firestore
        await db.collection("students").doc(user.uid).set({
          id: user.uid,
          email: user.email,
          fullName,
          studentNumber,
          fatherNumber,
          motherNumber,
          password,
          selfieURL,
          status: "في انتظار الموافقة",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // إخفاء النموذج وإظهار رسالة النجاح
        form.classList.add("hidden");
        successMsg.classList.remove("hidden");
        
        // إعادة تعيين النموذج
        form.reset();
      } catch (error) {
        console.error("حدث خطأ أثناء التسجيل:", error);
        alert("حدث خطأ: " + error.message);
      } finally {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });
    
    // معاينة الصورة المرفوعة
    document.getElementById("selfie").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const label = document.querySelector('.file-upload label');
          label.innerHTML = `
            <div class="flex items-center justify-center gap-4">
              <img src="${event.target.result}" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow" />
              <div class="text-right">
                <p class="text-gray-800 font-medium truncate">${file.name}</p>
                <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
              </div>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
