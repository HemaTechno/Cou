<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© | Ù…Ù†ØµØªÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-indigo-700">Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</h1>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ -->
    <label class="block mb-2 font-medium">Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</label>
    <select id="gradeSelect" class="w-full border p-2 rounded mb-4">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
      <option value="grade1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
      <option value="grade2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
      <option value="grade3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
    </select>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ ID -->
    <div class="flex items-center gap-2 mb-4">
      <div class="flex-1">
        <label class="block mb-2 font-medium">Ø§Ø®ØªØ± ID:</label>
        <select id="examSelect" class="w-full border p-2 rounded" onchange="checkNewId()">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù†/ID --</option>
          <option value="new">+ ID Ø¬Ø¯ÙŠØ¯</option>
        </select>
      </div>
      <button onclick="loadExamIds()" class="bg-blue-500 text-white px-3 py-2 rounded-lg mt-6">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <input type="text" id="newExamId" placeholder="Ø§ÙƒØªØ¨ ID Ø¬Ø¯ÙŠØ¯" 
      class="w-full border p-2 rounded mb-4 hidden"/>

    <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <div id="questionsContainer"></div>

    <button onclick="addQuestion()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg mt-4">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>

    <div class="mt-6">
      <button onclick="saveQuestions()" class="bg-green-600 text-white px-6 py-2 rounded-lg">ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let questionCount = 0;

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ IDs Ù…Ù† quizzes
    async function loadExamIds() {
      const select = document.getElementById("examSelect");
      select.innerHTML = `<option value="">-- Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù†/ID --</option>
                          <option value="new">+ ID Ø¬Ø¯ÙŠØ¯</option>`;
      const snapshot = await db.collection("quizzes").get();
      snapshot.forEach(doc => {
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = doc.id;
        select.appendChild(option);
      });
    }

    loadExamIds();

    // Ù„Ùˆ Ø§Ø®ØªØ§Ø± "ID Ø¬Ø¯ÙŠØ¯" ÙŠØ¸Ù‡Ø± input
    function checkNewId() {
      const select = document.getElementById("examSelect").value;
      const input = document.getElementById("newExamId");
      if (select === "new") {
        input.classList.remove("hidden");
      } else {
        input.classList.add("hidden");
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„
    function addQuestion() {
      questionCount++;
      const container = document.getElementById("questionsContainer");
      const div = document.createElement("div");
      div.className = "border p-4 rounded-lg mb-4 bg-gray-50";
      div.innerHTML = `
        <h3 class="font-bold mb-2">Ø³Ø¤Ø§Ù„ ${questionCount}</h3>
        
        <label class="block mb-1">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
        <textarea class="w-full border p-2 rounded mb-2" id="q_text_${questionCount}"></textarea>

        <label class="block mb-1">ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <input type="file" id="q_img_${questionCount}" class="mb-2"/>

        <label class="block mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
        <select id="q_type_${questionCount}" class="w-full border p-2 rounded mb-2" onchange="toggleOptions(${questionCount})">
          <option value="essay">Ù…Ù‚Ø§Ù„ÙŠ</option>
          <option value="mcq">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>
        </select>

        <div id="options_${questionCount}" class="hidden">
          <label class="block mb-1">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø§ÙØµÙ„Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©):</label>
          <input type="text" id="q_options_${questionCount}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªÙŠØ§Ø±1, Ø§Ø®ØªÙŠØ§Ø±2, Ø§Ø®ØªÙŠØ§Ø±3" class="w-full border p-2 rounded mb-2"/>
          <label class="block mb-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
          <input type="text" id="q_answer_${questionCount}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" class="w-full border p-2 rounded mb-2"/>
        </div>

        <label class="block mb-1">Ù‡Ù„ Ù…Ø³Ù…ÙˆØ­ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ</label>
        <select id="q_allowImg_${questionCount}" class="w-full border p-2 rounded">
          <option value="no">Ù„Ø§</option>
          <option value="yes">Ù†Ø¹Ù…</option>
        </select>
      `;
      container.appendChild(div);
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    function toggleOptions(id) {
      const type = document.getElementById(`q_type_${id}`).value;
      const optionsDiv = document.getElementById(`options_${id}`);
      if (type === "mcq") {
        optionsDiv.classList.remove("hidden");
      } else {
        optionsDiv.classList.add("hidden");
      }
    }

    // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    async function saveQuestions() {
      const grade = document.getElementById("gradeSelect").value;
      let examId = document.getElementById("examSelect").value;

      if (!grade || !examId) {
        alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆID");
        return;
      }

      // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± "ID Ø¬Ø¯ÙŠØ¯"
      if (examId === "new") {
        examId = document.getElementById("newExamId").value.trim();
        if (!examId) {
          alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø¬Ø¯ÙŠØ¯");
          return;
        }
        // Ø¥Ù†Ø´Ø§Ø¡ doc Ø¬Ø¯ÙŠØ¯ ÙÙŠ quizzes Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
        await db.collection("quizzes").doc(examId).set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }

      for (let i = 1; i <= questionCount; i++) {
        const text = document.getElementById(`q_text_${i}`).value;
        const type = document.getElementById(`q_type_${i}`).value;
        const allowImg = document.getElementById(`q_allowImg_${i}`).value;
        const file = document.getElementById(`q_img_${i}`).files[0];

        let imgUrl = "";
        if (file) {
          const storageRef = storage.ref(`questions/${examId}_${i}_${file.name}`);
          await storageRef.put(file);
          imgUrl = await storageRef.getDownloadURL();
        }

        let options = [];
        let answer = "";
        if (type === "mcq") {
          options = document.getElementById(`q_options_${i}`).value.split(",");
          answer = document.getElementById(`q_answer_${i}`).value;
        }

        await db.collection("quizzes").doc(examId).collection("questions").add({
          grade,
          text,
          type,
          options,
          answer,
          allowImg: allowImg === "yes",
          imgUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
      document.getElementById("questionsContainer").innerHTML = "";
      questionCount = 0;
    }
  </script>
</body>
</html>
