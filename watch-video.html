<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مشاهدة الفيديو</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.tailwindcss.com">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div id="video-container" class="w-full max-w-3xl p-4 bg-white rounded-xl shadow-lg hidden">
    <div class="relative pt-[56.25%]">
      <iframe id="videoFrame" class="absolute top-0 left-0 w-full h-full rounded-xl" 
              frameborder="0" allowfullscreen allow="autoplay"></iframe>
    </div>
  </div>
  <div id="error" class="text-center text-red-600 font-bold text-xl hidden mt-10"></div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const errorDiv = document.getElementById("error");
    const videoContainer = document.getElementById("video-container");
    const videoFrame = document.getElementById("videoFrame");

    const urlParams = new URLSearchParams(window.location.search);
    const contentId = urlParams.get("id"); // تأكد أن الرابط يحتوي على ?id=xxxx

    if (!contentId) {
      showError("رابط غير صالح");
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return showError("يجب تسجيل الدخول أولاً");

      try {
        // جلب بيانات الطالب
        const studentDoc = await db.collection("students").doc(user.uid).get();
        const studentData = studentDoc.data();
        if (!studentData || !studentData.enrolledCourses) return showError("أنت غير مشترك في أي كورس");

        // جلب المحتوى
        const contentDoc = await db.collection("lectureContent").doc(contentId).get();
        if (!contentDoc.exists) return showError("المحتوى غير موجود");

        const contentData = contentDoc.data();
        if (contentData.type !== "video") return showError("هذا ليس فيديو");

        // التحقق من الاشتراك في الكورس
        const lectureSnapshot = await db.collection("lectures").doc(contentData.lectureId).get();
        const lectureData = lectureSnapshot.data();
        if (!lectureData || !studentData.enrolledCourses.includes(lectureData.courseId)) {
          return showError("غير مسموح لك بمشاهدة هذا الفيديو");
        }

        // استخراج ID الفيديو من رابط YouTube
        const videoId = extractYouTubeId(contentData.url);
        if (!videoId) return showError("رابط الفيديو غير صالح");

        videoFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&rel=0`;
        videoContainer.classList.remove("hidden");

      } catch (err) {
        console.error(err);
        showError("حدث خطأ أثناء تحميل الفيديو");
      }
    });

    function extractYouTubeId(url) {
      const regex = /(?:youtube\.com.*(?:v=|\/embed\/)|youtu\.be\/)([^"&?/ ]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.remove("hidden");
    }
  </script>
</body>
</html>
