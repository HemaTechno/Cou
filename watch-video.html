<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>منصة التعليم - مشاهدة الفيديو</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --primary-color: #4f46e5;
      --secondary-color: #6366f1;
      --dark-color: #1e293b;
      --light-color: #f8fafc;
      --danger-color: #ef4444;
      --success-color: #10b981;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--dark-color);
      color: var(--light-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Header Styles */
    .header {
      background-color: rgba(0, 0, 0, 0.8);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(5px);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .logo i {
      font-size: 1.8rem;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* Video Wrapper */
    .video-wrapper {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 2rem auto;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      background-color: black;
    }
    
    .video-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
      height: 0;
    }
    
    #videoPlayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Video Controls */
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    
    .video-wrapper:hover .video-controls {
      opacity: 1;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .control-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    .progress-container {
      flex-grow: 1;
      height: 5px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      margin: 0 1rem;
      cursor: pointer;
      position: relative;
    }
    
    .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 5px;
      position: relative;
    }
    
    .time-display {
      color: white;
      font-size: 0.9rem;
      min-width: 80px;
      text-align: center;
    }
    
    /* Access Layer */
    .access-layer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 2rem;
      text-align: center;
    }
    
    .access-content {
      max-width: 600px;
      width: 100%;
      background-color: var(--dark-color);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--box-shadow);
    }
    
    .access-icon {
      font-size: 3rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .access-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    
    .access-message {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      line-height: 1.8;
    }
    
    .action-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .action-btn:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
    }
    
    .action-btn i {
      font-size: 1rem;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .video-controls {
        opacity: 1;
        padding: 0.5rem;
      }
      
      .control-btn {
        font-size: 1rem;
        width: 35px;
        height: 35px;
      }
      
      .access-content {
        padding: 1.5rem;
      }
      
      .access-title {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingContainer" class="loading-container">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <header class="header" id="header" style="display: none;">
    <div class="container header-content">
      <a href="/" class="logo">
        <i class="fas fa-graduation-cap"></i>
        <span>منصة التعليم</span>
      </a>
      <div class="user-info" id="userInfo">
        <div class="user-avatar" id="userAvatar">?</div>
      </div>
    </div>
  </header>

  <!-- Video Player -->
  <div class="container">
    <div class="video-wrapper" id="videoWrapper" style="display: none;">
      <div class="video-container">
        <iframe id="videoPlayer" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
      </div>
      <div class="video-controls">
        <div class="control-group">
          <button class="control-btn" id="playPauseBtn">
            <i class="fas fa-pause" id="playPauseIcon"></i>
          </button>
          <span class="time-display" id="currentTime">00:00</span>
        </div>
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="control-group">
          <span class="time-display" id="duration">00:00</span>
          <button class="control-btn" id="fullscreenBtn">
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Access Layer -->
  <div id="accessLayer" class="access-layer" style="display: none;">
    <div class="access-content">
      <div class="access-icon">
        <i class="fas fa-lock" id="accessIcon"></i>
      </div>
      <h2 class="access-title" id="accessTitle">يجب تسجيل الدخول</h2>
      <p class="access-message" id="accessMessage">يجب عليك تسجيل الدخول لمشاهدة هذا الفيديو</p>
      <button class="action-btn" id="accessActionBtn">
        <i class="fas fa-sign-in-alt" id="accessActionIcon"></i>
        <span id="accessActionText">تسجيل الدخول</span>
      </button>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const loadingContainer = document.getElementById("loadingContainer");
    const header = document.getElementById("header");
    const userInfo = document.getElementById("userInfo");
    const userAvatar = document.getElementById("userAvatar");
    const videoWrapper = document.getElementById("videoWrapper");
    const videoPlayer = document.getElementById("videoPlayer");
    const accessLayer = document.getElementById("accessLayer");
    const accessTitle = document.getElementById("accessTitle");
    const accessMessage = document.getElementById("accessMessage");
    const accessActionBtn = document.getElementById("accessActionBtn");
    const accessActionText = document.getElementById("accessActionText");
    const accessActionIcon = document.getElementById("accessActionIcon");
    const accessIcon = document.getElementById("accessIcon");

    // Video Controls
    const playPauseBtn = document.getElementById("playPauseBtn");
    const playPauseIcon = document.getElementById("playPauseIcon");
    const currentTimeDisplay = document.getElementById("currentTime");
    const durationDisplay = document.getElementById("duration");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const videoUrl = decodeURIComponent(params.get("url"));
    const videoTitleParam = decodeURIComponent(params.get("title") || "فيديو تعليمي");

    // Video state
    let isPlaying = false;
    let videoDuration = 0;

    // Initialize video player
    function initVideoPlayer(url) {
      const embedUrl = convertToEmbedUrl(url) + "?autoplay=1&rel=0&modestbranding=1";
      videoPlayer.src = embedUrl;
      
      // Listen for messages from the iframe (for YouTube API)
      window.addEventListener('message', onMessageReceived);
      
      // Show video wrapper
      videoWrapper.style.display = "block";
      
      // Set up controls
      setupControls();
    }

    // Setup video controls
    function setupControls() {
      // Play/Pause button
      playPauseBtn.addEventListener('click', togglePlayPause);
      
      // Fullscreen button
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      // Progress bar
      progressContainer.addEventListener('click', seekVideo);
      
      // Update time periodically
      setInterval(updateTimeDisplay, 1000);
    }

    // Toggle play/pause
    function togglePlayPause() {
      if (isPlaying) {
        postMessageToPlayer('pauseVideo');
        playPauseIcon.className = 'fas fa-play';
      } else {
        postMessageToPlayer('playVideo');
        playPauseIcon.className = 'fas fa-pause';
      }
      isPlaying = !isPlaying;
    }

    // Toggle fullscreen
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        videoWrapper.requestFullscreen().catch(err => {
          console.error('Error attempting to enable fullscreen:', err);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // Seek video
    function seekVideo(e) {
      const percent = e.offsetX / progressContainer.offsetWidth;
      const seekTime = percent * videoDuration;
      postMessageToPlayer('seekTo', seekTime);
    }

    // Update time display
    function updateTimeDisplay() {
      postMessageToPlayer('getCurrentTime');
      postMessageToPlayer('getDuration');
    }

    // Handle messages from iframe
    function onMessageReceived(event) {
      const data = event.data;
      
      // Handle YouTube player messages
      if (data.event === 'timeupdate') {
        const currentTime = data.currentTime;
        const duration = data.duration;
        
        // Update progress bar
        const percent = (currentTime / duration) * 100;
        progressBar.style.width = percent + '%';
        
        // Update time displays
        currentTimeDisplay.textContent = formatTime(currentTime);
        durationDisplay.textContent = formatTime(duration);
        
        // Update video duration
        videoDuration = duration;
      } else if (data.event === 'playbackStatus') {
        isPlaying = data.isPlaying;
        playPauseIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
      }
    }

    // Post message to player (YouTube API)
    function postMessageToPlayer(action, value) {
      videoPlayer.contentWindow.postMessage({
        event: 'command',
        func: action,
        args: value !== undefined ? [value] : null
      }, '*');
    }

    // Format time (seconds to MM:SS)
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Show access layer
    function showAccessLayer(title, message, actionText, icon) {
      accessTitle.textContent = title;
      accessMessage.textContent = message;
      accessActionText.textContent = actionText;
      
      if (icon === 'lock') {
        accessIcon.className = 'fas fa-lock';
        accessActionIcon.className = 'fas fa-sign-in-alt';
      } else if (icon === 'warning') {
        accessIcon.className = 'fas fa-exclamation-triangle';
        accessActionIcon.className = 'fas fa-redo';
      }
      
      accessLayer.style.display = "flex";
      loadingContainer.style.display = "none";
    }

    // Handle access action button
    accessActionBtn.addEventListener('click', () => {
      if (auth.currentUser) {
        window.location.reload();
      } else {
        window.location.href = "/login?redirect=" + encodeURIComponent(window.location.href);
      }
    });

    // Convert to embed URL
    function convertToEmbedUrl(url) {
      // Handle YouTube URLs
      if (url.includes("youtube.com") || url.includes("youtu.be")) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        const videoId = (match && match[2].length === 11) ? match[2] : null;
        return `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
      }
      
      // Handle Vimeo URLs
      if (url.includes("vimeo.com")) {
        const regExp = /^.*(vimeo.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/;
        const match = url.match(regExp);
        const videoId = match ? match[5] : null;
        return `https://player.vimeo.com/video/${videoId}`;
      }
      
      // Default case (direct video URL)
      return url;
    }

    // Auth state listener
    auth.onAuthStateChanged(async user => {
      try {
        if (!user) {
          showAccessLayer("يجب تسجيل الدخول", "يجب عليك تسجيل الدخول لمشاهدة هذا الفيديو", "تسجيل الدخول", "lock");
          return;
        }

        // Update user info in header
        header.style.display = "block";
        userAvatar.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
        
        // Check user access
        const userDoc = await db.collection("students").doc(user.uid).get();
        if (!userDoc.exists) {
          throw new Error("لا يوجد بيانات للمستخدم في نظامنا.");
        }

        const studentData = userDoc.data();
        const enrolledCourses = studentData.enrolledCourses || [];

        // Get video data from Firestore
        const videoSnapshot = await db.collection("lectureContent").where("url", "==", videoUrl).get();
        if (videoSnapshot.empty) {
          throw new Error("عذراً، لا يمكن العثور على الفيديو المطلوب.");
        }

        const videoData = videoSnapshot.docs[0].data();
        const lectureId = videoData.lectureId;

        const lectureSnapshot = await db.collection("lectures").doc(lectureId).get();
        if (!lectureSnapshot.exists) {
          throw new Error("عذراً، لا يمكن العثور على المحاضرة المرتبطة بهذا الفيديو.");
        }

        const courseId = lectureSnapshot.data().courseId;

        // Check if user is enrolled in the course
        if (!enrolledCourses.includes(courseId)) {
          showAccessLayer(
            "غير مسموح بالوصول", 
            "عذراً، يجب عليك الاشتراك في هذه الدورة التدريبية لمشاهدة هذا الفيديو.", 
            "الذهاب للدورة",
            "warning"
          );
          return;
        }

        // Initialize video player
        initVideoPlayer(videoUrl);
        
      } catch (err) {
        console.error("Error:", err);
        showAccessLayer("حدث خطأ", err.message || "حدث خطأ غير متوقع أثناء تحميل الفيديو.", "حاول مرة أخرى", "warning");
      } finally {
        loadingContainer.style.display = "none";
      }
    });
  </script>
</body>
</html>
