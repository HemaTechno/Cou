<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مشاهدة الفيديو</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; margin: 0; background-color: #111827; color: white; }
    .container { max-width: 1000px; margin: auto; padding: 20px; }
    .video-box { position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 30px rgba(0,0,0,0.3); background: #000; }
    iframe { width: 100%; height: 500px; border: none; pointer-events: none; }
    .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: transparent; z-index: 3; pointer-events: auto; }
    .controls { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    .controls button {
      padding: 10px 20px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #1e40af;
    }
    .watermark {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      font-size: 18px;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.3);
      animation: moveWatermark 20s infinite linear;
    }
    @keyframes moveWatermark {
      0%   { transform: translate(0%, 0%); }
      25%  { transform: translate(80%, 20%); }
      50%  { transform: translate(60%, 60%); }
      75%  { transform: translate(20%, 80%); }
      100% { transform: translate(0%, 0%); }
    }
    #errorBox { color: red; text-align: center; margin-top: 50px; font-size: 1.2rem; }
  </style>
</head>
<body>
  <div class="container">
    <div id="errorBox" style="display: none;"></div>
    <div class="video-box" id="videoBox" style="display: none;">
      <div class="watermark" id="watermark">طالب</div>
      <iframe id="videoFrame" allowfullscreen></iframe>
      <div class="overlay"></div>
    </div>
    <div class="controls" id="controlButtons" style="display: none;">
      <button id="playPauseBtn">⏸ إيقاف</button>
      <button id="fullscreenBtn">⛶ ملء الشاشة</button>
    </div>
  </div>

  <script>
    // Firebase config
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const videoUrl = decodeURIComponent(params.get("url"));
    const videoId = videoUrl.split("/").pop();

    const iframe = document.getElementById("videoFrame");
    const errorBox = document.getElementById("errorBox");
    const videoBox = document.getElementById("videoBox");
    const controls = document.getElementById("controlButtons");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const watermark = document.getElementById("watermark");

    let player;

    auth.onAuthStateChanged(async user => {
      if (!user) return showError("يجب تسجيل الدخول أولاً.");

      try {
        const userDoc = await db.collection("students").doc(user.uid).get();
        if (!userDoc.exists) throw new Error("بيانات الطالب غير موجودة.");
        const student = userDoc.data();
        const enrolled = student.enrolledCourses || [];

        const contentSnap = await db.collection("lectureContent").where("url", "==", videoUrl).get();
        if (contentSnap.empty) throw new Error("الفيديو غير متوفر.");

        const contentData = contentSnap.docs[0].data();
        const lectureId = contentData.lectureId;
        const lectureSnap = await db.collection("lectures").doc(lectureId).get();
        const courseId = lectureSnap.data().courseId;

        if (!enrolled.includes(courseId)) return showError("أنت غير مشترك في هذا الكورس.");

        watermark.textContent = student.name || user.uid;
        iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&controls=0&rel=0&modestbranding=1`;
        videoBox.style.display = "block";
        controls.style.display = "flex";

        loadYouTubeAPI();

      } catch (err) {
        console.error(err);
        showError(err.message);
      }
    });

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
    }

    function loadYouTubeAPI() {
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.body.appendChild(tag);
    }

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player("videoFrame", {
        events: {
          onReady: (event) => {
            event.target.playVideo();
          }
        }
      });
    };

    playPauseBtn.addEventListener("click", () => {
      if (!player) return;
      const state = player.getPlayerState();
      if (state === YT.PlayerState.PLAYING) {
        player.pauseVideo();
        playPauseBtn.textContent = "▶️ تشغيل";
      } else {
        player.playVideo();
        playPauseBtn.textContent = "⏸ إيقاف";
      }
    });

    document.getElementById("fullscreenBtn").addEventListener("click", () => {
      const el = document.getElementById("videoBox");
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    });

    // منع أدوات المطور
    document.addEventListener("keydown", function(e) {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key)) ||
        (e.ctrlKey && e.key === "U") ||
        (e.key === "PrintScreen")
      ) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
