<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام إدارة المحتوى التعليمي</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    }
    .card {
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      border: 1px solid rgba(209, 213, 219, 0.3);
    }
    .progress-bar {
      height: 6px;
      background: linear-gradient(90deg, #4f46e5 0%, #a855f7 100%);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-indigo-800 mb-2">نظام إدارة المحتوى التعليمي</h1>
      <p class="text-gray-600">أضف محتوى تعليمي بسهولة واحترافية</p>
    </div>

    <!-- Main Card -->
    <div class="card shadow-xl p-6 md:p-8 space-y-6">
      <div class="flex items-center justify-between border-b pb-4">
        <h2 class="text-xl md:text-2xl font-bold text-indigo-700">
          <i class="fas fa-plus-circle mr-2"></i> إضافة محتوى جديد
        </h2>
        <div class="flex items-center space-x-2 space-x-reverse">
          <span class="text-sm text-gray-500">الحالة:</span>
          <span id="statusIndicator" class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">جاهز</span>
        </div>
      </div>

      <!-- اختيار الصف والكورس والمحاضرة -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">الصف الدراسي</label>
          <select id="stage" class="w-full border border-gray-300 px-4 py-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="" disabled selected>اختر الصف الدراسي</option>
            <option value="الصف الأول">الصف الأول</option>
            <option value="الصف الثاني">الصف الثاني</option>
            <option value="الصف الثالث">الصف الثالث</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">الكورس التعليمي</label>
          <select id="course" class="w-full border border-gray-300 px-4 py-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" disabled>
            <option value="" disabled selected>اختر الكورس</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">المحاضرة</label>
          <select id="lectureId" class="w-full border border-gray-300 px-4 py-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" disabled>
            <option value="" disabled selected>اختر المحاضرة</option>
          </select>
        </div>
      </div>

      <!-- نموذج إضافة المحتوى -->
      <form id="contentForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">عنوان المحتوى</label>
          <input type="text" id="title" placeholder="أدخل عنوان المحتوى" required 
                 class="w-full border border-gray-300 px-4 py-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">نوع المحتوى</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <label class="flex items-center space-x-2 space-x-reverse p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 transition has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-300">
              <input type="radio" name="type" value="video" checked class="text-indigo-600 focus:ring-indigo-500">
              <div>
                <span class="block font-medium">فيديو</span>
                <span class="block text-xs text-gray-500">رفع رابط فيديو</span>
              </div>
              <i class="fas fa-video ml-auto text-indigo-400"></i>
            </label>
            
            <label class="flex items-center space-x-2 space-x-reverse p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 transition has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-300">
              <input type="radio" name="type" value="pdf" class="text-indigo-600 focus:ring-indigo-500">
              <div>
                <span class="block font-medium">ملف PDF</span>
                <span class="block text-xs text-gray-500">رفع ملف PDF</span>
              </div>
              <i class="fas fa-file-pdf ml-auto text-red-400"></i>
            </label>
            
            <label class="flex items-center space-x-2 space-x-reverse p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 transition has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-300">
              <input type="radio" name="type" value="quiz" class="text-indigo-600 focus:ring-indigo-500">
              <div>
                <span class="block font-medium">اختبار</span>
                <span class="block text-xs text-gray-500">إضافة اختبار</span>
              </div>
              <i class="fas fa-question-circle ml-auto text-purple-400"></i>
            </label>
          </div>
        </div>

        <!-- حقل الفيديو -->
        <div id="videoField">
          <label class="block text-sm font-medium text-gray-700 mb-1">رابط الفيديو</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
              <i class="fas fa-link"></i>
            </div>
            <input type="url" id="videoUrl" placeholder="https://example.com/video" 
                   class="w-full border border-gray-300 pl-10 pr-4 py-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
          </div>
        </div>

        <!-- حقل PDF مع عداد التحميل -->
        <div id="pdfField" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">ملف PDF</label>
          <div class="flex items-center justify-center w-full">
            <label for="pdfFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
              <div class="flex flex-col items-center justify-center pt-5 pb-6" id="pdfUploadText">
                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">انقر لرفع الملف</span> أو اسحبه هنا</p>
                <p class="text-xs text-gray-500">PDF فقط (حتى 10MB)</p>
              </div>
              <input id="pdfFile" type="file" accept="application/pdf" class="hidden" />
            </label>
          </div>
          
          <!-- Progress Bar -->
          <div id="pdfProgress" class="hidden mt-3">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
              <span id="fileName">جاري التحميل...</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5">
              <div id="progressBar" class="progress-bar h-1.5 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- File Info -->
          <div id="fileInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              <span class="text-sm font-medium text-green-800">تم تحميل الملف بنجاح</span>
              <button id="removeFile" class="mr-auto text-red-500 hover:text-red-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="mt-1 text-xs text-green-700" id="fileDetails"></div>
          </div>
        </div>

        <!-- حقل الاختبار -->
        <div id="quizField" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">معرف الاختبار</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
              <i class="fas fa-id-card"></i>
            </div>
            <input type="text" id="quizId" placeholder="أدخل معرف الاختبار" 
                   class="w-full border border-gray-300 pl-10 pr-4 py-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
          </div>
        </div>

        <button type="submit" id="submitBtn" 
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition flex items-center justify-center">
          <i class="fas fa-save mr-2"></i> حفظ المحتوى
        </button>
      </form>

      <!-- رسالة النجاح -->
      <div id="successMsg" class="hidden p-4 bg-green-100 border-l-4 border-green-500 text-green-700">
        <div class="flex items-center">
          <i class="fas fa-check-circle text-green-500 mr-2"></i>
          <div>
            <p class="font-semibold">تم بنجاح!</p>
            <p class="text-sm">تم إضافة المحتوى بنجاح إلى قاعدة البيانات.</p>
          </div>
          <button id="closeSuccess" class="mr-auto text-green-700 hover:text-green-900">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-6 text-sm text-gray-500">
      <p>نظام إدارة المحتوى التعليمي &copy; 2023</p>
    </div>
  </div>

  <script>
    // Firebase Init
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com"
    });

    const db = firebase.firestore();
    const storage = firebase.storage();

    // عناصر الواجهة
    const stageSelect = document.getElementById("stage");
    const courseSelect = document.getElementById("course");
    const lectureSelect = document.getElementById("lectureId");
    const videoField = document.getElementById("videoField");
    const pdfField = document.getElementById("pdfField");
    const quizField = document.getElementById("quizField");
    const videoUrl = document.getElementById("videoUrl");
    const pdfInput = document.getElementById("pdfFile");
    const quizInput = document.getElementById("quizId");
    const form = document.getElementById("contentForm");
    const successMsg = document.getElementById("successMsg");
    const submitBtn = document.getElementById("submitBtn");
    const statusIndicator = document.getElementById("statusIndicator");
    const pdfUploadText = document.getElementById("pdfUploadText");
    const pdfProgress = document.getElementById("pdfProgress");
    const fileInfo = document.getElementById("fileInfo");
    const fileDetails = document.getElementById("fileDetails");
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");
    const fileName = document.getElementById("fileName");
    const removeFile = document.getElementById("removeFile");
    const closeSuccess = document.getElementById("closeSuccess");

    // متغيرات التطبيق
    let uploadedFileUrl = '';
    let uploadedFileName = '';

    // تغيير حالة النظام
    function setStatus(text, color = 'gray') {
      statusIndicator.textContent = text;
      statusIndicator.className = `px-2 py-1 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800`;
    }

    // اختيار الصف => تحميل الكورسات
    stageSelect.addEventListener("change", async () => {
      const stage = stageSelect.value;
      courseSelect.innerHTML = '<option disabled selected>جاري التحميل...</option>';
      courseSelect.disabled = true;
      setStatus('جاري تحميل الكورسات...', 'blue');

      try {
        const snapshot = await db.collection("courses").where("stage", "==", stage).get();
        courseSelect.innerHTML = '<option value="" disabled selected>اختر الكورس</option>';
        
        if (snapshot.empty) {
          courseSelect.innerHTML = '<option disabled selected>لا توجد كورسات متاحة</option>';
          setStatus('لا توجد كورسات', 'yellow');
        } else {
          snapshot.forEach(doc => {
            const c = doc.data();
            const option = document.createElement("option");
            option.value = c.id;
            option.textContent = c.name;
            courseSelect.appendChild(option);
          });
          setStatus('اختر كورس', 'green');
        }

        courseSelect.disabled = false;
        lectureSelect.innerHTML = '<option disabled selected>اختر المحاضرة</option>';
        lectureSelect.disabled = true;
      } catch (error) {
        console.error("Error loading courses:", error);
        setStatus('خطأ في التحميل', 'red');
      }
    });

    // اختيار الكورس => تحميل المحاضرات
    courseSelect.addEventListener("change", async () => {
      const courseId = courseSelect.value;
      setStatus('جاري تحميل المحاضرات...', 'blue');

      try {
        const snapshot = await db.collection("lectures").where("courseId", "==", courseId).get();
        lectureSelect.innerHTML = '<option value="" disabled selected>اختر المحاضرة</option>';
        
        if (snapshot.empty) {
          lectureSelect.innerHTML = '<option disabled selected>لا توجد محاضرات متاحة</option>';
          setStatus('لا توجد محاضرات', 'yellow');
        } else {
          snapshot.forEach(doc => {
            const l = doc.data();
            const option = document.createElement("option");
            option.value = l.id;
            option.textContent = l.lectureTitle;
            lectureSelect.appendChild(option);
          });
          setStatus('اختر محاضرة', 'green');
        }

        lectureSelect.disabled = false;
      } catch (error) {
        console.error("Error loading lectures:", error);
        setStatus('خطأ في التحميل', 'red');
      }
    });

    // تغيير نوع المحتوى
    document.querySelectorAll('input[name="type"]').forEach(r => {
      r.addEventListener("change", () => {
        const type = r.value;
        videoField.classList.toggle("hidden", type !== "video");
        pdfField.classList.toggle("hidden", type !== "pdf");
        quizField.classList.toggle("hidden", type !== "quiz");
      });
    });

    // إدارة رفع ملف PDF
    pdfInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // التحقق من نوع الملف
      if (file.type !== "application/pdf") {
        alert("الرجاء اختيار ملف PDF فقط");
        return;
      }

      // التحقق من حجم الملف (10MB كحد أقصى)
      if (file.size > 10 * 1024 * 1024) {
        alert("حجم الملف كبير جداً. الحد الأقصى 10MB");
        return;
      }

      uploadedFileName = file.name;
      fileName.textContent = file.name;
      pdfUploadText.classList.add("hidden");
      pdfProgress.classList.remove("hidden");
      fileInfo.classList.add("hidden");

      // رفع الملف إلى Firebase Storage
      uploadFile(file);
    });

    // دالة رفع الملف مع متابعة التقدم
    function uploadFile(file) {
      setStatus('جاري رفع الملف...', 'blue');
      submitBtn.disabled = true;
      
      const fileRef = storage.ref(`pdfs/${Date.now()}_${file.name}`);
      const uploadTask = fileRef.put(file);

      uploadTask.on('state_changed',
        (snapshot) => {
          // تحديث شريط التقدم
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
        },
        (error) => {
          console.error("Upload error:", error);
          setStatus('خطأ في الرفع', 'red');
          resetPdfUpload();
        },
        () => {
          // عند اكتمال الرفع
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            uploadedFileUrl = downloadURL;
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            
            // عرض معلومات الملف
            pdfProgress.classList.add("hidden");
            fileInfo.classList.remove("hidden");
            fileDetails.innerHTML = `
              <span class="font-medium">${file.name}</span><br>
              <span>${(file.size / (1024 * 1024)).toFixed(2)} MB</span>
            `;
            
            setStatus('تم رفع الملف', 'green');
            submitBtn.disabled = false;
          });
        }
      );
    }

    // إزالة الملف المرفوع
    removeFile.addEventListener("click", (e) => {
      e.preventDefault();
      resetPdfUpload();
    });

    // إعادة تعيين حقل PDF
    function resetPdfUpload() {
      pdfInput.value = '';
      uploadedFileUrl = '';
      uploadedFileName = '';
      progressBar.style.width = '0%';
      progressPercent.textContent = '0%';
      pdfUploadText.classList.remove("hidden");
      pdfProgress.classList.add("hidden");
      fileInfo.classList.add("hidden");
      submitBtn.disabled = false;
      setStatus('جاهز', 'green');
    }

    // إغلاق رسالة النجاح
    closeSuccess.addEventListener("click", () => {
      successMsg.classList.add("hidden");
    });

    // إرسال النموذج
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const lectureId = lectureSelect.value;
      const title = document.getElementById("title").value.trim();
      const type = document.querySelector('input[name="type"]:checked').value;

      if (!lectureId || !title) {
        alert("الرجاء تعبئة جميع الحقول المطلوبة");
        return;
      }

      let url = '';
      setStatus('جاري الحفظ...', 'blue');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> جاري الحفظ...';

      try {
        if (type === "video") {
          url = videoUrl.value.trim();
          if (!url) {
            alert("الرجاء إدخال رابط الفيديو");
            throw new Error("No video URL");
          }
        } else if (type === "pdf") {
          if (!uploadedFileUrl) {
            alert("الرجاء رفع ملف PDF أولاً");
            throw new Error("No PDF file");
          }
          url = uploadedFileUrl;
        } else if (type === "quiz") {
          url = quizInput.value.trim();
          if (!url) {
            alert("الرجاء إدخال معرف الاختبار");
            throw new Error("No quiz ID");
          }
        }

        // حفظ البيانات في Firestore
        await db.collection("lectureContent").add({
          lectureId,
          title,
          type,
          url,
          fileName: type === 'pdf' ? uploadedFileName : null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // إعادة تعيين النموذج
        form.reset();
        videoField.classList.remove("hidden");
        pdfField.classList.add("hidden");
        quizField.classList.add("hidden");
        resetPdfUpload();
        
        // عرض رسالة النجاح
        successMsg.classList.remove("hidden");
        setStatus('تم الحفظ بنجاح', 'green');
        
        // إعادة تعيين الزر
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> حفظ المحتوى';
        }, 2000);
        
        // إخفاء رسالة النجاح بعد 5 ثواني
        setTimeout(() => {
          successMsg.classList.add("hidden");
        }, 5000);
      } catch (err) {
        console.error(err);
        setStatus('خطأ في الحفظ', 'red');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> حفظ المحتوى';
        
        // عرض رسالة الخطأ
        alert("❌ حدث خطأ أثناء حفظ البيانات: " + err.message);
      }
    });
  </script>
</body>
</html>
