<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>إدارة الكورسات | منصة عبدالرحمن السقا</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-6xl mx-auto space-y-10">

    <!-- ✅ نموذج إضافة / تعديل كورس -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-xl font-bold text-indigo-700 mb-4" id="formTitle">➕ إضافة كورس جديد</h2>

      <form id="courseForm" class="space-y-4">
        <input type="hidden" id="courseId" />
        <input type="text" id="courseName" placeholder="اسم الكورس" required class="w-full border px-4 py-2 rounded-lg text-right" />
        <textarea id="courseDescription" placeholder="وصف الكورس" rows="3" required class="w-full border px-4 py-2 rounded-lg text-right"></textarea>

        <select id="stage" required class="w-full border px-4 py-2 rounded-lg">
          <option value="" disabled selected>اختر المرحلة الدراسية</option>
          <option value="الصف الأول">الصف الأول</option>
          <option value="الصف الثاني">الصف الثاني</option>
          <option value="الصف الثالث">الصف الثالث</option>
        </select>

        <label class="block font-medium">صورة الكورس:</label>
        <input type="file" id="courseImage" accept="image/*" class="w-full border px-4 py-2 bg-gray-50 rounded-lg" />

        <div class="flex gap-4 items-center">
          <label><input type="radio" name="isFree" value="true" checked /> مجاني</label>
          <label><input type="radio" name="isFree" value="false" /> مدفوع</label>
        </div>

        <input type="number" id="price" placeholder="عدد الكوينات" min="1" class="w-full border px-4 py-2 rounded-lg text-right hidden" />

        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition">💾 حفظ الكورس</button>
      </form>

      <p id="successMsg" class="text-center text-green-600 mt-4 hidden">✅ تم حفظ الكورس بنجاح!</p>
    </div>

    <!-- ✅ قائمة الكورسات -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-xl font-bold text-indigo-700 mb-4">📚 الكورسات المضافة</h2>
      <div id="coursesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

  </div>

  <script>
    // Firebase init
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f"
    });

    const db = firebase.firestore();
    const storage = firebase.storage();

    const form = document.getElementById("courseForm");
    const priceInput = document.getElementById("price");
    const successMsg = document.getElementById("successMsg");

    // Show/hide price field
    document.querySelectorAll('input[name="isFree"]').forEach(radio => {
      radio.addEventListener("change", () => {
        priceInput.classList.toggle("hidden", radio.value === "true");
      });
    });

    // حفظ أو تعديل كورس
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const courseId = document.getElementById("courseId").value || "COURSE_" + Date.now();
      const name = document.getElementById("courseName").value.trim();
      const description = document.getElementById("courseDescription").value.trim();
      const stage = document.getElementById("stage").value;
      const isFree = document.querySelector('input[name="isFree"]:checked').value === "true";
      const price = isFree ? 0 : parseInt(priceInput.value);
      const imageFile = document.getElementById("courseImage").files[0];

      if (!name || !description || !stage || (!isFree && (!price || price <= 0))) {
        alert("يرجى تعبئة جميع الحقول المطلوبة");
        return;
      }

      try {
        let imageURL = "";
        if (imageFile) {
          const imageRef = storage.ref(`courses/${courseId}.jpg`);
          await imageRef.put(imageFile);
          imageURL = await imageRef.getDownloadURL();
        }

        const courseData = {
          id: courseId,
          name,
          description,
          stage,
          isFree,
          price,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (imageURL) courseData.imageURL = imageURL;

        await db.collection("courses").doc(courseId).set(courseData, { merge: true });

        form.reset();
        document.getElementById("formTitle").textContent = "➕ إضافة كورس جديد";
        priceInput.classList.add("hidden");
        successMsg.classList.remove("hidden");
        setTimeout(() => successMsg.classList.add("hidden"), 3000);
        loadCourses();

      } catch (err) {
        console.error(err);
        alert("❌ خطأ أثناء الحفظ");
      }
    });

    // تحميل الكورسات
    async function loadCourses() {
      const res = await db.collection("courses").orderBy("createdAt", "desc").get();
      const list = document.getElementById("coursesList");
      list.innerHTML = "";

      res.forEach(doc => {
        const c = doc.data();
        const card = document.createElement("div");
        card.className = "bg-gray-50 rounded-xl shadow p-4 space-y-2";

        card.innerHTML = `
          <img src="${c.imageURL || '#'}" class="w-full h-40 object-cover rounded-md mb-2">
          <h3 class="text-lg font-bold text-indigo-700">${c.name}</h3>
          <p class="text-sm text-gray-600">${c.description}</p>
          <p class="text-xs text-gray-500">المرحلة: ${c.stage}</p>
          <p class="text-xs text-${c.isFree ? "green" : "yellow"}-600">${c.isFree ? "مجاني" : "مدفوع: " + c.price + " 🪙"}</p>
          <div class="flex justify-between gap-2 mt-2">
            <button onclick="editCourse('${c.id}')" class="bg-blue-600 text-white text-sm px-3 py-1 rounded">تعديل</button>
            <button onclick="deleteCourse('${c.id}')" class="bg-red-600 text-white text-sm px-3 py-1 rounded">حذف</button>
          </div>
        `;
        list.appendChild(card);
      });
    }

    // تعديل
    async function editCourse(id) {
      const doc = await db.collection("courses").doc(id).get();
      if (!doc.exists) return;

      const c = doc.data();
      document.getElementById("formTitle").textContent = "✏️ تعديل كورس";
      document.getElementById("courseId").value = c.id;
      document.getElementById("courseName").value = c.name;
      document.getElementById("courseDescription").value = c.description;
      document.getElementById("stage").value = c.stage;
      document.querySelector(`input[name="isFree"][value="${c.isFree ? "true" : "false"}"]`).checked = true;

      if (!c.isFree) {
        priceInput.value = c.price;
        priceInput.classList.remove("hidden");
      } else {
        priceInput.classList.add("hidden");
      }
    }

    // حذف
    async function deleteCourse(id) {
      if (!confirm("هل أنت متأكد أنك تريد حذف هذا الكورس؟")) return;
      try {
        await db.collection("courses").doc(id).delete();
        await storage.ref(`courses/${id}.jpg`).delete();
        loadCourses();
      } catch (err) {
        console.error(err);
        alert("❌ خطأ أثناء الحذف");
      }
    }

    // أول تحميل
    loadCourses();
  </script>
</body>
</html>
