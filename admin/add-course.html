<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>إضافة كورس | منصة عبدالرحمن السقا</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap');
    body { 
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    .form-container {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .btn-submit {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      transition: all 0.3s ease;
    }
    .btn-submit:hover {
      background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
    }
    .input-field {
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input-field:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
    }
    .radio-btn:checked {
      background-color: #4f46e5;
      border-color: #4f46e5;
    }
    .upload-label {
      border: 2px dashed #cbd5e1;
      transition: all 0.3s ease;
    }
    .upload-label:hover {
      border-color: #818cf8;
      background-color: #f8fafc;
    }
    .file-selected {
      border-color: #4f46e5;
      background-color: #eef2ff;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

  <div class="form-container bg-white p-6 md:p-10 rounded-2xl w-full max-w-2xl">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-indigo-900 mb-2 flex items-center justify-center gap-2">
        <i data-feather="plus-circle" class="w-8 h-8"></i>
        إضافة كورس جديد
      </h2>
      <p class="text-gray-600">املأ النموذج أدناه لإضافة كورس جديد إلى المنصة</p>
    </div>

    <form id="courseForm" class="space-y-6">
      <div>
        <label for="courseName" class="block text-right font-medium text-gray-700 mb-2">اسم الكورس</label>
        <div class="relative">
          <input type="text" id="courseName" placeholder="أدخل اسم الكورس" required 
                 class="input-field w-full border border-gray-300 px-4 py-3 rounded-xl text-right pr-12" />
          <i data-feather="book" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i>
        </div>
      </div>
      
      <div>
        <label for="courseDescription" class="block text-right font-medium text-gray-700 mb-2">وصف الكورس</label>
        <div class="relative">
          <textarea id="courseDescription" placeholder="أدخل وصفاً تفصيلياً للكورس" rows="4" required 
                    class="input-field w-full border border-gray-300 px-4 py-3 rounded-xl text-right pr-12"></textarea>
          <i data-feather="align-left" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i>
        </div>
      </div>
      
      <div>
        <label for="stage" class="block text-right font-medium text-gray-700 mb-2">المرحلة الدراسية</label>
        <div class="relative">
          <select id="stage" required class="input-field w-full border border-gray-300 px-4 py-3 rounded-xl text-right appearance-none pr-12">
            <option value="" disabled selected>اختر المرحلة الدراسية</option>
            <option value="الصف الأول">الصف الأول</option>
            <option value="الصف الثاني">الصف الثاني</option>
            <option value="الصف الثالث">الصف الثالث</option>
          </select>
          <i data-feather="chevron-down" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5 pointer-events-none"></i>
        </div>
      </div>

      <div>
        <label class="block text-right font-medium text-gray-700 mb-2">صورة الكورس</label>
        <label id="uploadLabel" for="courseImage" class="upload-label flex flex-col items-center justify-center p-6 rounded-xl cursor-pointer">
          <i data-feather="upload" class="w-10 h-10 text-gray-400 mb-3"></i>
          <span class="text-gray-600 text-center">
            <span class="font-medium text-indigo-600">اضغط لرفع صورة</span> أو اسحبها هنا<br>
            <span class="text-sm text-gray-500">(JPEG, PNG بحد أقصى 5MB)</span>
          </span>
          <span id="fileName" class="mt-2 text-sm text-indigo-700 hidden"></span>
          <input type="file" id="courseImage" accept="image/*" required class="hidden"/>
        </label>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-xl">
          <label class="flex items-center justify-between cursor-pointer">
            <span class="text-gray-700 font-medium">نوع الكورس</span>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2">
                <input type="radio" name="isFree" value="true" checked class="radio-btn h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <span>مجاني</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="isFree" value="false" class="radio-btn h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <span>مدفوع</span>
              </label>
            </div>
          </label>
        </div>

        <div id="priceContainer" class="bg-gray-50 p-4 rounded-xl hidden">
          <label for="price" class="block text-right font-medium text-gray-700 mb-2">سعر الكورس</label>
          <div class="relative">
            <input type="number" id="price" placeholder="عدد الكوينات المطلوبة" min="1" 
                   class="input-field w-full border border-gray-300 px-4 py-2 rounded-lg text-right pr-12" />
            <span class="absolute left-3 top-2 text-gray-500">🪙</span>
          </div>
        </div>
      </div>

      <button type="submit" id="submitBtn" class="btn-submit w-full text-white py-3 px-6 rounded-xl font-medium flex items-center justify-center gap-2">
        <i data-feather="save" class="w-5 h-5"></i>
        حفظ الكورس
      </button>

      <div id="loadingIndicator" class="hidden flex-col items-center justify-center py-4">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-indigo-500 mb-3"></div>
        <p class="text-gray-600">جاري رفع الكورس، يرجى الانتظار...</p>
        <p id="uploadProgress" class="text-sm text-indigo-600 mt-1"></p>
      </div>

      <div id="successMsg" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-center">
        <div class="flex items-center justify-center gap-2">
          <i data-feather="check-circle" class="w-5 h-5 text-green-600"></i>
          <span class="font-medium">تم حفظ الكورس بنجاح!</span>
        </div>
        <p class="mt-1 text-sm">يمكنك الآن عرض الكورس في قائمة الكورسات المتاحة</p>
      </div>
    </form>
  </div>

  <script>
    // Initialize Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f"
    });

    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // Initialize feather icons
    document.addEventListener('DOMContentLoaded', () => {
      feather.replace();
    });

    // Show/hide price field based on radio
    document.querySelectorAll('input[name="isFree"]').forEach(radio => {
      radio.addEventListener("change", () => {
        const priceContainer = document.getElementById("priceContainer");
        priceContainer.classList.toggle("hidden", radio.value === "true");
        if (radio.value === "true") {
          document.getElementById("price").value = "";
        }
      });
    });

    // Handle file upload display
    const courseImageInput = document.getElementById("courseImage");
    if (courseImageInput) {
      courseImageInput.addEventListener("change", (e) => {
        const uploadLabel = document.getElementById("uploadLabel");
        const fileName = document.getElementById("fileName");
        
        if (e.target.files && e.target.files.length > 0) {
          const file = e.target.files[0];
          uploadLabel.classList.add("file-selected");
          fileName.textContent = file.name;
          fileName.classList.remove("hidden");
          
          // Show preview if image
          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = (event) => {
              uploadLabel.innerHTML = `
                <img src="${event.target.result}" class="h-32 object-cover rounded-lg mb-2">
                <span class="text-indigo-600 text-sm">${file.name}</span>
              `;
            };
            reader.readAsDataURL(file);
          }
        } else {
          uploadLabel.classList.remove("file-selected");
          fileName.classList.add("hidden");
          uploadLabel.innerHTML = `
            <i data-feather="upload" class="w-10 h-10 text-gray-400 mb-3"></i>
            <span class="text-gray-600 text-center">
              <span class="font-medium text-indigo-600">اضغط لرفع صورة</span> أو اسحبها هنا<br>
              <span class="text-sm text-gray-500">(JPEG, PNG بحد أقصى 5MB)</span>
            </span>
          `;
          feather.replace();
        }
      });
    }

    // Handle form submission
    document.getElementById("courseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById("submitBtn");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const successMsg = document.getElementById("successMsg");
      
      // Get form values
      const name = document.getElementById("courseName").value.trim();
      const description = document.getElementById("courseDescription").value.trim();
      const stage = document.getElementById("stage").value;
      const imageInput = document.getElementById("courseImage");
      const isFree = document.querySelector('input[name="isFree"]:checked').value === "true";
      const price = isFree ? 0 : parseInt(document.getElementById("price").value);

      // Validation
      if (!name || !description || !stage || !imageInput || !imageInput.files || imageInput.files.length === 0 || (!isFree && (!price || price <= 0))) {
        alert("⚠️ يرجى تعبئة كل الحقول المطلوبة بشكل صحيح");
        return;
      }

      const imageFile = imageInput.files[0];

      // Disable submit button and show loading
      submitBtn.disabled = true;
      submitBtn.classList.add("opacity-50", "cursor-not-allowed");
      loadingIndicator.classList.remove("hidden");
      
      const courseId = "COURSE_" + Date.now();

      try {
        // Upload image with progress
        const imageRef = storage.ref(`courses/${courseId}.jpg`);
        const uploadTask = imageRef.put(imageFile);
        
        // Track upload progress
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById("uploadProgress").textContent = `تم رفع ${Math.round(progress)}%`;
          },
          (error) => {
            console.error("Upload error:", error);
            alert("❌ حدث خطأ أثناء رفع الصورة");
            resetForm();
          },
          async () => {
            // Upload completed successfully
            const imageURL = await uploadTask.snapshot.ref.getDownloadURL();

            // Save course to Firestore
            await db.collection("courses").doc(courseId).set({
              id: courseId,
              name,
              description,
              stage,
              isFree,
              price,
              imageURL,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Show success message
            successMsg.classList.remove("hidden");
            loadingIndicator.classList.add("hidden");
            
            // Reset form after delay
            setTimeout(() => {
              document.getElementById("courseForm").reset();
              document.getElementById("uploadLabel").classList.remove("file-selected");
              document.getElementById("fileName").classList.add("hidden");
              document.getElementById("priceContainer").classList.add("hidden");
              successMsg.classList.add("hidden");
              submitBtn.disabled = false;
              submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
              
              // Reset upload label content
              document.getElementById("uploadLabel").innerHTML = `
                <i data-feather="upload" class="w-10 h-10 text-gray-400 mb-3"></i>
                <span class="text-gray-600 text-center">
                  <span class="font-medium text-indigo-600">اضغط لرفع صورة</span> أو اسحبها هنا<br>
                  <span class="text-sm text-gray-500">(JPEG, PNG بحد أقصى 5MB)</span>
                </span>
              `;
              feather.replace();
            }, 3000);
          }
        );
      } catch (err) {
        console.error("Error:", err);
        alert("❌ حدث خطأ غير متوقع أثناء الحفظ");
        resetForm();
      }
    });

    function resetForm() {
      document.getElementById("submitBtn").disabled = false;
      document.getElementById("submitBtn").classList.remove("opacity-50", "cursor-not-allowed");
      document.getElementById("loadingIndicator").classList.add("hidden");
    }
  </script>
</body>
</html>
