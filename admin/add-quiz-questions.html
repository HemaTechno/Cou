<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>إضافة سؤال للاختبار</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
    <h1 class="text-2xl font-bold text-indigo-700">إضافة سؤال للاختبار</h1>

    <select id="stageSelect" class="w-full border p-2 rounded">
      <option value="">اختر الصف</option>
      <option value="الصف الأول">الصف الأول</option>
      <option value="الصف الثاني">الصف الثاني</option>
      <option value="الصف الثالث">الصف الثالث</option>
    </select>

    <select id="courseSelect" class="w-full border p-2 rounded">
      <option value="">اختر الكورس</option>
    </select>

    <select id="lectureSelect" class="w-full border p-2 rounded">
      <option value="">اختر المحاضرة</option>
    </select>

    <select id="quizSelect" class="w-full border p-2 rounded">
      <option value="">اختر ID الاختبار</option>
    </select>

    <input id="questionText" class="w-full border p-2 rounded" placeholder="نص السؤال" />
    <input type="file" id="questionImage" accept="image/*" class="w-full border p-2 rounded" />

    <input id="optionA" class="w-full border p-2 rounded" placeholder="الاختيار (أ)" />
    <input id="optionB" class="w-full border p-2 rounded" placeholder="الاختيار (ب)" />
    <input id="optionC" class="w-full border p-2 rounded" placeholder="الاختيار (ج)" />
    <input id="optionD" class="w-full border p-2 rounded" placeholder="الاختيار (د)" />

    <select id="correctAnswer" class="w-full border p-2 rounded">
      <option value="">اختر الإجابة الصحيحة</option>
      <option value="A">أ</option>
      <option value="B">ب</option>
      <option value="C">ج</option>
      <option value="D">د</option>
    </select>

    <button onclick="addQuestion()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">➕ إضافة السؤال</button>
    <p id="status" class="text-center text-green-600 mt-4 font-bold"></p>
  </div>

  <script>
    // Firebase init
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
    });

    const db = firebase.firestore();
    const storage = firebase.storage();

    const stageSelect = document.getElementById("stageSelect");
    const courseSelect = document.getElementById("courseSelect");
    const lectureSelect = document.getElementById("lectureSelect");
    const quizSelect = document.getElementById("quizSelect");

    stageSelect.addEventListener("change", async () => {
      const stage = stageSelect.value;
      courseSelect.innerHTML = `<option value="">جاري التحميل...</option>`;
      const snap = await db.collection("courses").where("stage", "==", stage).get();

      courseSelect.innerHTML = `<option value="">اختر الكورس</option>`;
      snap.forEach(doc => {
        const data = doc.data();
        courseSelect.innerHTML += `<option value="${doc.id}">${data.name}</option>`;
      });
    });

    courseSelect.addEventListener("change", async () => {
      const courseId = courseSelect.value;
      lectureSelect.innerHTML = `<option value="">جاري التحميل...</option>`;
      const snap = await db.collection("lectures").where("courseId", "==", courseId).get();

      lectureSelect.innerHTML = `<option value="">اختر المحاضرة</option>`;
      snap.forEach(doc => {
        const data = doc.data();
        lectureSelect.innerHTML += `<option value="${doc.id}">${data.lectureTitle}</option>`;
      });
    });

    lectureSelect.addEventListener("change", async () => {
      const lectureId = lectureSelect.value;
      quizSelect.innerHTML = `<option value="">جاري التحميل...</option>`;
      const snap = await db.collection("lectureContent").where("lectureId", "==", lectureId).where("type", "==", "quiz").get();

      quizSelect.innerHTML = `<option value="">اختر ID الاختبار</option>`;
      snap.forEach(doc => {
        quizSelect.innerHTML += `<option value="${doc.data().url}">${doc.data().title} - ${doc.data().url}</option>`;
      });
    });

    async function addQuestion() {
      const quizId = quizSelect.value;
      const question = document.getElementById("questionText").value;
      const imgFile = document.getElementById("questionImage").files[0];
      const A = document.getElementById("optionA").value;
      const B = document.getElementById("optionB").value;
      const C = document.getElementById("optionC").value;
      const D = document.getElementById("optionD").value;
      const correct = document.getElementById("correctAnswer").value;
      const status = document.getElementById("status");

      if (!quizId || !question || !A || !B || !C || !D || !correct) {
        alert("الرجاء تعبئة جميع الحقول");
        return;
      }

      let imageUrl = "";
      if (imgFile) {
        const ref = storage.ref("quizImages/" + Date.now() + "_" + imgFile.name);
        await ref.put(imgFile);
        imageUrl = await ref.getDownloadURL();
      }

      await db.collection("quizzes").add({
        quizId: quizId,
        question: question,
        imageUrl: imageUrl,
        options: { A, B, C, D },
        correct: correct,
        createdAt: new Date()
      });

      status.textContent = "✅ تم إضافة السؤال بنجاح!";
      document.getElementById("questionText").value = "";
      document.getElementById("questionImage").value = "";
      document.getElementById("optionA").value = "";
      document.getElementById("optionB").value = "";
      document.getElementById("optionC").value = "";
      document.getElementById("optionD").value = "";
      document.getElementById("correctAnswer").value = "";
    }
  </script>
</body>
</html>



