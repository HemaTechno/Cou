<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; padding: 20px; }
    .question { margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
    .option { margin: 5px 0; }
    .timer { font-size: 18px; color: red; margin-bottom: 20px; }
    .submit-btn { padding: 10px 20px; background: green; color: white; border: none; border-radius: 8px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
<div class="timer" id="timer">Ù£:Ù Ù :Ù Ù </div>
<form id="quizForm"></form>
<button id="submitBtn" class="submit-btn">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
    authDomain: "hhhhhh-d4fb8.firebaseapp.com",
    projectId: "hhhhhh-d4fb8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const quizForm = document.getElementById('quizForm');
  const submitBtn = document.getElementById('submitBtn');
  const timerDisplay = document.getElementById('timer');
  const params = new URLSearchParams(window.location.search);
  const quizId = params.get("id");

  let currentUser;
  let questions = [];
  let startedAt;
  let timer;

  auth.onAuthStateChanged(async (user) => {
    if (!user) return window.location.href = "/login.html";
    currentUser = user;
    const studentRef = db.collection("students").doc(user.uid);
    const studentDoc = await studentRef.get();
    const studentData = studentDoc.data();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    const contentSnap = await db.collection("lectureContent").where("type", "==", "quiz").where("url", "==", quizId).get();
    if (contentSnap.empty) return alert("Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    const lecture = contentSnap.docs[0].data();
    const courseId = lecture.courseId;
    if (!studentData.enrolledCourses?.includes(courseId)) return window.location.href = "/";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (studentData.quizAttempts?.[quizId]) {
      Swal.fire("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„ÙØ¹Ù„", "", "info");
      submitBtn.disabled = true;
      return;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    const quizDoc = await db.collection("quizzes").doc(quizId).get();
    questions = quizDoc.data().questions;

    // ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
    questions = questions.sort(() => Math.random() - 0.5).map(q => ({
      ...q,
      options: q.options.sort(() => Math.random() - 0.5)
    }));

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    questions.forEach((q, index) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `<p><strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</strong> ${q.question}</p>` +
        q.options.map(opt => `
          <div class="option">
            <label>
              <input type="radio" name="q${index}" value="${opt}" required />
              ${opt}
            </label>
          </div>`).join('');
      quizForm.appendChild(div);
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
    startedAt = Date.now();
    let remaining = 3 * 60 * 60; // 3 Ø³Ø§Ø¹Ø§Øª Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

    function updateTimer() {
      const hours = Math.floor(remaining / 3600);
      const minutes = Math.floor((remaining % 3600) / 60);
      const seconds = remaining % 60;
      timerDisplay.textContent = `${hours}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
      if (remaining <= 0) {
        clearInterval(timer);
        submitQuiz();
      }
      remaining--;
    }

    updateTimer();
    timer = setInterval(updateTimer, 1000);
  });

  submitBtn.addEventListener("click", (e) => {
    e.preventDefault();
    submitQuiz();
  });

  async function submitQuiz() {
    clearInterval(timer);
    const formData = new FormData(quizForm);
    let score = 0;
    const answers = [];

    questions.forEach((q, i) => {
      const userAnswer = formData.get(`q${i}`);
      const correct = q.correct;
      answers.push({
        question: q.question,
        correct,
        selected: userAnswer || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±"
      });
      if (userAnswer === correct) score++;
    });

    const endTime = Date.now();
    const duration = Math.floor((endTime - startedAt) / 1000); // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

    await db.collection("students").doc(currentUser.uid).set({
      quizAttempts: {
        [quizId]: {
          score,
          startedAt: firebase.firestore.Timestamp.fromMillis(startedAt),
          submittedAt: firebase.firestore.Timestamp.fromMillis(endTime),
          duration,
          answers
        }
      }
    }, { merge: true });

    Swal.fire({
      title: `ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…`,
      html: `
        <p>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score} / ${questions.length}</p>
        <hr>
        <h3>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>
        ${answers.map((a, i) => `
          <p><strong>Ø³${i + 1}:</strong> ${a.question}<br>
          âœ… <strong>Ø§Ù„ØµØ­ÙŠØ­Ø©:</strong> ${a.correct}<br>
          ðŸ“Œ <strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${a.selected}</p>
        `).join('')}
      `,
      icon: "success"
    });
  }
</script>

</body>
</html>
