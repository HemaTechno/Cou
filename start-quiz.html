<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“˜ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f5f5f5; }
    .question-card { border: 2px solid #ddd; padding: 20px; border-radius: 8px; background: white; }
    .btn { padding: 10px 16px; border-radius: 6px; cursor: pointer; }
    .btn-prev { background: #ccc; }
    .btn-next { background: #4f46e5; color: white; }
    .btn-submit { background: #e11d48; color: white; width: 100%; margin-top: 20px; }
    .indicator { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; margin: 0 4px; }
    .current { background: #60a5fa; color: white; }
    .answered { background: #34d399; color: white; }
    .unanswered { background: #f87171; color: white; }
  </style>
</head>
<body>

  <div class="max-w-xl mx-auto my-8 bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ Ø§Ø®ØªØ¨Ø§Ø±</h1>
    <div id="timer" class="text-red-600 font-bold mb-4 text-right">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª...</div>
    <div id="indicators" class="mb-4 text-center"></div>
    <div id="questionArea"></div>
    <div class="flex justify-between mt-4">
      <button id="prevBtn" class="btn btn-prev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="nextBtn" class="btn btn-next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
    <button id="submitBtn" class="btn btn-submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    <div id="resultBox" class="mt-6 hidden"></div>
  </div>

<script>
  firebase.initializeApp({
    apiKey: "...", authDomain: "...", projectId: "hhhhhh-d4fb8"
  });
  const auth = firebase.auth();
  const db = firebase.firestore();

  const quizId = new URLSearchParams(window.location.search).get("id");
  let questions = [], current = 0, startedAt = null;
  const timerEl = document.getElementById("timer");
  const area = document.getElementById("questionArea");
  const prevBtn = document.getElementById("prevBtn"), nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const indicators = document.getElementById("indicators");
  const resultBox = document.getElementById("resultBox");
  let answers = {};

  auth.onAuthStateChanged(async user => {
    if (!user) return location.href = "login.html";
    const uDoc = await db.collection("students").doc(user.uid).get();
    if (!uDoc.exists) return alert("Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    const stud = uDoc.data();

    const quizDoc = await db.collection("lectureContent").where("url", "==", quizId).get();
    if (quizDoc.empty) return alert("Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    const lecId = quizDoc.docs[0].data().lectureId;
    const lec = await db.collection("lectures").doc(lecId).get();
    const courseId = lec.data().courseId;

    if (!stud.enrolledCourses?.includes(courseId)) {
      return alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†");
    }

    const prev = await db.collection("students").doc(user.uid)
      .collection("quizResults").doc(quizId).get();

    if (prev.exists) {
      const d = prev.data();
      return showResult(d.score, d.answers, new Date(d.startedAt?.toMillis()), new Date(d.submittedAt?.toMillis()));
    }

    const snapQ = await db.collection("quizzes").doc(quizId).collection("questions").get();
    if (snapQ.empty) return area.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©.</p>";

    questions = snapQ.docs.map(d => ({ id: d.id, ...d.data() }));
    shuffle(questions);
    buildIndicators();
    showQuestion(0);

    startedAt = Date.now();
    startTimer();

  });

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} }

  function buildIndicators(){
    indicators.innerHTML = questions.map((_,i)=>
      `<span id="ind${i}" class="indicator unanswered">${i+1}</span>`).join('');
  }

  function showQuestion(i){
    current = i;
    const q = questions[i];
    let opts = Object.entries(q.options);
    shuffle(opts);
    area.innerHTML = `<div class="question-card">
      <h2 class="mb-3">${i+1}. ${q.question}</h2>
      ${opts.map(([k,v])=>`
        <label><input type="radio" name="q${i}" value="${k}" 
          ${answers[q.id]===k?'checked':''}/> ${k}. ${v}</label><br>`).join('')}
    </div>`;
    indicators.classList;
    updateIndicators();
  }

  function updateIndicators(){
    questions.forEach((q,i)=>{
      const el = document.getElementById(`ind${i}`);
      el.className = 'indicator ' + (answers[questions[i].id] ? 'answered' : 'unanswered') + (i===current?' current':'');
    });
  }

  prevBtn.onclick =()=>{ if(current>0) showQuestion(current-1); };
  nextBtn.onclick =()=>{ if(current<questions.length-1) showQuestion(current+1); };

  area.addEventListener('change', e=>{
    if(e.target.name.startsWith('q')){
      answers[questions[current].id]=e.target.value;
      updateIndicators();
    }
  });

  submitBtn.onclick = async ()=>{
    const total = questions.length;
    const correct = questions.filter(q=>answers[q.id]===q.correct).length;
    const score = Math.round((correct/total)*100);
    const now = Date.now();
    await db.collection("students").doc(auth.currentUser.uid)
      .collection("quizResults").doc(quizId).set({
        score, answers, startedAt: firebase.firestore.FieldValue.timestampfromMillis(startedAt),
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    showResult(score, answers, new Date(startedAt), new Date());
  };

  function showResult(score, answersMap, from, to){
    area.style.display = 'none';
    prevBtn.style.display=nextBtn.style.display=submitBtn.style.display='none';
    timerEl.style.display='none';
    indicators.style.display='none';
    resultBox.classList.remove('hidden');
    let html = `<h2 class="text-xl font-bold text-green-600 mb-4">âœ… Ù†ØªÙŠØ¬ØªÙƒ: ${score}%</h2>
      <p>Ø¨Ø¯Ø£Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${from.toLocaleString()}</p><p>Ø§Ù†ØªÙ‡ÙŠØª: ${to.toLocaleString()}</p><hr>`;
    questions.forEach((q,i)=>{
      html+= `<div class="my-3">
        <strong>${i+1}. ${q.question}</strong><br>
        Ø¥Ø¬Ø§Ø¨ØªÙƒ: <span style="color:${answersMap[q.id]===q.correct?'green':'red'}">${answersMap[q.id]||'Ù„Ù… ÙŠØ¬Ø¨'}</span><br>
        Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <span style="color:green">${q.correct}</span></div>`;
    });
    resultBox.innerHTML = html;
  }

  function startTimer(){
    const end = startedAt + 3*60*60*1000;
    const iv = setInterval(()=>{
      const rem = end - Date.now();
      if(rem<=0){ clearInterval(iv); submitBtn.click(); }
      else {
        const h = Math.floor(rem/3600000), m = Math.floor(rem%3600000/60000), s=Math.floor(rem%60000/1000);
        timerEl.textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      }
    },1000);
  }

</script>

</body>
</html>
