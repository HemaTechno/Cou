<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>حل الاختبار</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
  <h2>الاختبار</h2>
  <div id="quizContainer"></div>
  <button onclick="nextQuestion()">التالي</button>
  <button onclick="submitQuiz()">تسليم</button>
  <div id="result"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let current = 0, questions = [], answers = [];

    const params = new URLSearchParams(window.location.search);
    const quizId = params.get("id");

    auth.onAuthStateChanged(async user => {
      if (!user) return alert("❌ سجل الدخول أولاً");

      const userData = await db.collection("students").doc(user.uid).get();
      const enrolled = userData.data().enrolledCourses || [];

      const snap = await db.collection("lectureContent").where("url", "==", quizId).get();
      const lectureId = snap.docs[0].data().lectureId;
      const courseDoc = await db.collection("lectures").doc(lectureId).get();
      const courseId = courseDoc.data().courseId;

      const course = await db.collection("courses").doc(courseId).get();
      const isFree = course.data().isFree;

      if (!isFree && !enrolled.includes(courseId)) {
        return alert("❌ غير مشترك في الكورس");
      }

      const qSnap = await db.collection("quizzes").doc(quizId).collection("questions").get();
      questions = qSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (!questions.length) {
        document.getElementById("quizContainer").innerText = "لا يوجد أسئلة.";
        return;
      }

      showQuestion();
    });

    function showQuestion() {
      const q = questions[current];
      const container = document.getElementById("quizContainer");
      container.innerHTML = `<h3>${q.question}</h3>`;
      if (q.image) container.innerHTML += `<img src="${q.image}" style="max-width:200px" />`;
      q.options.forEach((opt, i) => {
        container.innerHTML += `
          <div>
            <input type="radio" name="answer" value="${i}" id="opt${i}">
            <label for="opt${i}">${opt}</label>
          </div>`;
      });
    }

    function nextQuestion() {
      const selected = document.querySelector("input[name='answer']:checked");
      if (!selected) return alert("اختر إجابة أولاً");

      answers[current] = parseInt(selected.value);
      current++;
      if (current < questions.length) {
        showQuestion();
      } else {
        alert("تم الوصول للسؤال الأخير. اضغط تسليم.");
      }
    }

    async function submitQuiz() {
      const user = firebase.auth().currentUser;
      if (!user) return;

      let score = 0;
      questions.forEach((q, i) => {
        if (answers[i] === q.correctIndex) score++;
      });

      await db.collection("quizResults").add({
        studentId: user.uid,
        quizId,
        answers,
        score,
        total: questions.length,
        timestamp: new Date()
      });

      document.getElementById("result").innerText = `✅ تم تسليم الاختبار. نتيجتك: ${score} من ${questions.length}`;
    }
  </script>
</body>
</html>

