<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center items-center">

  <div id="quizBox" class="max-w-3xl w-full bg-white p-6 rounded-xl shadow-lg text-center">
    <h1 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ“˜ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
    <p id="status">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</p>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Ù‚Ø±Ø§Ø¡Ø© examId Ùˆ userId Ù…Ù† Ø§Ù„Ù„ÙŠÙ†Ùƒ
    const params = new URLSearchParams(window.location.search);
    const examId = params.get("id");
    const userId = params.get("user");

    let questions = [];
    let answers = {};
    let attempts = 0;
    let currentIndex = 0;
    let timerInterval;

    async function checkAccess() {
      const box = document.getElementById("quizBox");
      const status = document.getElementById("status");

      // Ù†Ø¬ÙŠØ¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
      const subDoc = await db.collection("quizzes").doc(examId)
                    .collection("submissions").doc(userId).get();
      attempts = subDoc.exists ? (subDoc.data().attempts || 0) : 0;

      if (attempts >= 2) {
        status.innerText = "âŒ Ø§Ø³ØªÙ‡Ù„ÙƒØª ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª (2)";
        return;
      }

      status.innerText = "";
      box.innerHTML += `
        <button onclick="startExam()" class="bg-green-600 text-white px-6 py-3 mt-4 rounded-lg">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
      `;
    }

    async function startExam() {
      const box = document.getElementById("quizBox");

      // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      const snap = await db.collection("quizzes").doc(examId).collection("questions").get();
      questions = snap.docs.map(d => ({id: d.id, ...d.data()}));

      box.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <span id="timer" class="text-red-600 font-bold">â³ 3:00:00</span>
          <span>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts+1} Ù…Ù† 2</span>
        </div>
        <div id="questionBox" class="p-4 border rounded bg-gray-50"></div>
        <div class="mt-4 flex justify-between">
          <button onclick="prevQuestion()" class="bg-gray-400 text-white px-4 py-2 rounded">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button onclick="nextQuestion()" class="bg-blue-600 text-white px-4 py-2 rounded">â¡ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
        <div class="mt-6 flex gap-4 justify-center">
          <button onclick="saveProgress()" class="bg-yellow-500 text-white px-6 py-2 rounded">ğŸ’¾ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§</button>
          <button onclick="submitExam()" class="bg-green-600 text-white px-6 py-2 rounded">ğŸ“¤ ØªØ³Ù„ÙŠÙ…</button>
        </div>
      `;

      renderQuestion();
      startTimer(3 * 60 * 60);
    }

    function renderQuestion() {
      const q = questions[currentIndex];
      const box = document.getElementById("questionBox");

      let html = `<h2 class="font-bold mb-2">Ø³Ø¤Ø§Ù„ ${currentIndex+1}</h2>
                  <p class="mb-2">${q.text}</p>`;

      if (q.imgUrl) {
        html += `<img src="${q.imgUrl}" class="mb-2 max-h-40 mx-auto"/>`;
      }

      if (q.type === "mcq") {
        html += `<div class="space-y-2">`;
        q.options.forEach(opt => {
          const checked = answers[q.id] === opt ? "checked" : "";
          html += `<label class="block"><input type="radio" name="q_${q.id}" value="${opt}" ${checked} onchange="saveAnswer('${q.id}', this.value)"> ${opt}</label>`;
        });
        html += `</div>`;
      } else {
        const saved = answers[q.id] || "";
        html += `<textarea class="w-full border p-2 rounded" rows="4" onchange="saveAnswer('${q.id}', this.value)">${saved}</textarea>`;
      }

      box.innerHTML = html;
    }

    function saveAnswer(qid, value) {
      answers[qid] = value;
    }

    function prevQuestion() {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    }

    function nextQuestion() {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      }
    }

    async function saveProgress() {
      await db.collection("quizzes").doc(examId).collection("submissions").doc(userId).set({
        answers,
        attempts,
        status: "in-progress",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§");
    }

    async function submitExam() {
      clearInterval(timerInterval);
      let score = 0;
      questions.forEach(q => {
        if (q.type === "mcq" && answers[q.id] === q.answer) {
          score++;
        }
      });

      await db.collection("quizzes").doc(examId).collection("submissions").doc(userId).set({
        answers,
        attempts: attempts+1,
        score,
        status: "submitted",
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById("quizBox").innerHTML = `
        <h2 class="text-xl font-bold text-green-600">âœ… ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
        <p class="mt-2">Ø³ÙŠØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ¥Ø®Ø¨Ø§Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø©.</p>
        <p class="mt-2">Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©: ${score} / ${questions.filter(q=>q.type==='mcq').length}</p>
      `;
    }

    function startTimer(duration) {
      let time = duration;
      const timerEl = document.getElementById("timer");
      timerInterval = setInterval(() => {
        const h = String(Math.floor(time / 3600)).padStart(2, "0");
        const m = String(Math.floor((time % 3600) / 60)).padStart(2, "0");
        const s = String(time % 60).padStart(2, "0");
        timerEl.innerText = `â³ ${h}:${m}:${s}`;
        if (--time < 0) {
          clearInterval(timerInterval);
          submitExam();
        }
      }, 1000);
    }

    checkAccess();
  </script>
</body>
</html>


