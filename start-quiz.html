<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .certificate-bg {
      background: url('https://i.imgur.com/JW4JwQp.jpg') no-repeat center center;
      background-size: cover;
      position: relative;
    }
    .certificate-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
    }
    .certificate-border {
      border: 20px solid transparent;
      border-image: url('https://i.imgur.com/5nZlWqk.png') 30 round;
    }
    .gold-text {
      background: linear-gradient(to right, #D4AF37, #F9D423);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .signature-box {
      background: url('https://i.imgur.com/XYZ1234.png') no-repeat center center;
      background-size: contain;
      height: 80px;
      width: 200px;
      margin: 0 auto;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-2xl">
    <h1 class="text-4xl font-bold text-center text-indigo-800 mb-6">ğŸ“ Ø§Ø®ØªØ¨Ø§Ø±</h1>
    <p id="timer" class="text-right text-red-600 font-bold mb-6 text-xl">â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª...</p>
    <div id="quizContainer" class="space-y-8"></div>
    <button id="submitBtn" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 font-bold text-xl shadow-lg transition-all duration-300 transform hover:scale-[1.01]">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
    <p id="resultMsg" class="text-center font-bold text-green-600 mt-8 hidden text-2xl"></p>

    <!-- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ÙØ®Ù…Ø© Ø¨Ø¯ÙˆÙ† Ø²Ø± ØªØ­Ù…ÙŠÙ„ -->
    <div id="certificateBox" class="hidden mt-10 p-10 rounded-3xl text-center relative overflow-hidden certificate-border certificate-bg">
      <div class="relative z-10">
        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¤Ø³Ø³Ø© -->
        <div class="flex justify-center mb-6">
          <img src="https://i.imgur.com/ABC1234.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¤Ø³Ø³Ø©" class="h-24">
        </div>
        
        <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© -->
        <h2 class="text-5xl font-black mb-8 gold-text">Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±</h2>
        
        <!-- Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ -->
        <div class="my-8">
          <p class="text-4xl font-bold text-indigo-900 mb-2" id="certStudentName"></p>
          <p class="text-2xl text-gray-700">ØªÙ… Ù…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±Ø§Ù‹ Ù„Ù„Ø¬Ù‡ÙˆØ¯ Ø§Ù„Ù…Ø¨Ø°ÙˆÙ„Ø©</p>
        </div>
        
        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
        <div class="bg-white/80 p-6 rounded-xl shadow-inner my-8 mx-auto max-w-lg backdrop-blur-sm">
          <p class="text-3xl font-bold text-gray-800 mb-4">Ø§Ø®ØªØ¨Ø§Ø±: <span id="certQuizName" class="text-indigo-700"></span></p>
          <p class="text-2xl font-bold text-gray-800">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="certScore" class="text-green-700 text-3xl"></span>%</p>
          <p class="text-xl mt-4">Ø¨ØªØ§Ø±ÙŠØ®: <span id="certDate" class="font-semibold"></span></p>
        </div>
        
        <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ -->
        <div class="mt-12 flex justify-between items-end px-16">
          <div class="text-center">
            <div class="signature-box" id="signature"></div>
            <p class="text-lg font-semibold mt-2">Ø±Ø¦ÙŠØ³ Ù„Ø¬Ù†Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>
          </div>
          <div class="text-center">
            <div class="border-t-2 border-gray-400 w-48 pt-2">
              <p class="text-lg font-semibold">Ø®ØªÙ… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</p>
            </div>
          </div>
        </div>
        
        <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© -->
        <div class="mt-16 text-sm text-gray-600">
          <p>Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØµØ§Ø¯Ø±Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2023</p>
          <p class="mt-1">Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: <span id="certNumber" class="font-mono">${Math.random().toString(36).substring(2, 10).toUpperCase()}</span></p>
        </div>
      </div>
      
      <!-- Ø§Ù„Ø²Ø®Ø§Ø±Ù Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
      <div class="absolute top-8 left-8 opacity-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#4F46E5" stroke-width="2">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2z"></path>
        </svg>
      </div>
      <div class="absolute bottom-8 right-8 opacity-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#4F46E5" stroke-width="2">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2z"></path>
        </svg>
      </div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const quizId = params.get("id");
    const quizContainer = document.getElementById("quizContainer");
    const submitBtn = document.getElementById("submitBtn");
    const resultMsg = document.getElementById("resultMsg");
    const timerElement = document.getElementById("timer");

    let currentUser, correctAnswers = 0, totalQuestions = 0, student;

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù…Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ
    function loadSignature(imageUrl) {
      const signatureBox = document.getElementById("signature");
      signatureBox.style.backgroundImage = `url(${imageUrl})`;
    }

    // Ù…Ø«Ø§Ù„ Ù„ØªØ­Ù…ÙŠÙ„ ØªÙˆÙ‚ÙŠØ¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ)
    loadSignature("https://i.imgur.com/XYZ1234.png");

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;

      const userDoc = await db.collection("students").doc(user.uid).get();
      if (!userDoc.exists) return alert("Ø­Ø³Ø§Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­");
      student = userDoc.data();

      const resultDoc = await db.collection("students").doc(user.uid).collection("quizResults").doc(quizId).get();
      if (resultDoc.exists) {
        const resultData = resultDoc.data();
        const score = resultData.score;
        const date = resultData.date?.toDate().toLocaleDateString("ar-EG") || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

        resultMsg.innerHTML = `âœ… Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø­Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø§Ø¨Ù‚Ù‹Ø§.<br>Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span class="text-3xl">${score}%</span><br>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`;
        resultMsg.classList.remove("hidden");

        document.getElementById("certStudentName").textContent = student.fullName || 'Ø·Ø§Ù„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„';
        document.getElementById("certQuizName").textContent = quizId;
        document.getElementById("certScore").textContent = score;
        document.getElementById("certDate").textContent = date;
        document.getElementById("certificateBox").classList.remove("hidden");
      }

      const questionsSnap = await db.collection("quizzes").doc(quizId).collection("questions").get();
      if (questionsSnap.empty) {
        quizContainer.innerHTML = `<p class="text-center text-gray-500 text-xl">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
        submitBtn.style.display = "none";
        return;
      }

      totalQuestions = questionsSnap.size;

      questionsSnap.forEach((doc, idx) => {
        const q = doc.data();
        const box = document.createElement("div");
        box.className = "border-2 border-gray-200 p-8 rounded-2xl bg-gradient-to-br from-gray-50 to-white shadow-lg hover:shadow-xl transition-all duration-300";

        let imgHTML = q.imageURL ? `<img src="${q.imageURL}" class="w-full max-w-md mb-6 rounded-xl border-2 border-gray-200 mx-auto shadow" />` : "";

        box.innerHTML = `
          ${imgHTML}
          <h2 class="font-bold text-2xl mb-6 text-indigo-900">${idx + 1}. ${q.question}</h2>
          <div class="space-y-4">
            ${['A', 'B', 'C', 'D'].map(opt => `
              <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer transition-all duration-200">
                <input type="radio" name="q${doc.id}" value="${opt}" class="h-6 w-6 text-indigo-600 focus:ring-indigo-500">
                <span class="mr-4 text-lg text-gray-800">${q.options?.[opt] || ""}</span>
              </label>
            `).join('')}
          </div>
        `;
        quizContainer.appendChild(box);
      });

      startTimer();
    });

    function startTimer() {
      const duration = 3 * 60 * 60 * 1000;
      const endTime = Date.now() + duration;

      const interval = setInterval(() => {
        const remaining = endTime - Date.now();

        if (remaining <= 0) {
          clearInterval(interval);
          timerElement.textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.";
          submitQuiz();
          return;
        }

        const h = Math.floor(remaining / (1000 * 60 * 60));
        const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((remaining % (1000 * 60)) / 1000);

        timerElement.textContent = `â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }, 1000);
    }

    submitBtn.addEventListener("click", () => submitQuiz());

    async function submitQuiz() {
      const questionsSnap = await db.collection("quizzes").doc(quizId).collection("questions").get();
      correctAnswers = 0;

      const answersList = [];

      questionsSnap.forEach(doc => {
        const q = doc.data();
        const selected = document.querySelector(`input[name="q${doc.id}"]:checked`);
        const selectedValue = selected?.value || "Ù„Ù… ÙŠØ¬Ø¨";
        const correctAnswer = q.correct;

        if (selectedValue === correctAnswer) correctAnswers++;

        answersList.push({
          question: q.question,
          correct: correctAnswer,
          selected: selectedValue,
          options: q.options
        });
      });

      const score = Math.round((correctAnswers / totalQuestions) * 100);

      await db.collection("students").doc(currentUser.uid).collection("quizResults").doc(quizId).set({
        score,
        date: firebase.firestore.FieldValue.serverTimestamp()
      });

      resultMsg.innerHTML = `ğŸ‰ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­<br>Ù†ØªÙŠØ¬ØªÙƒ: <span class="text-4xl ${score >= 50 ? 'text-green-600' : 'text-red-600'}">${score}%</span>`;
      resultMsg.classList.remove("hidden");
      submitBtn.disabled = true;

      document.getElementById("certStudentName").textContent = student.fullName || 'Ø·Ø§Ù„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„';
      document.getElementById("certQuizName").textContent = quizId;
      document.getElementById("certScore").textContent = score;
      document.getElementById("certDate").textContent = new Date().toLocaleDateString("ar-EG");
      document.getElementById("certificateBox").classList.remove("hidden");

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        downloadCertificate();
      }, 3000);

      quizContainer.innerHTML = "";
      answersList.forEach((item, i) => {
        const box = document.createElement("div");
        box.className = `border-2 ${item.selected === item.correct ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'} p-6 rounded-2xl mb-6`;
        box.innerHTML = `
          <h3 class="font-bold text-xl text-gray-800">${i + 1}. ${item.question}</h3>
          <p class="mt-3 ${item.selected === item.correct ? 'text-green-700' : 'text-red-700'}">
            <span class="font-bold">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span> ${item.options?.[item.selected] || item.selected}
          </p>
          ${item.selected !== item.correct ? `
            <p class="text-green-700 mt-2">
              <span class="font-bold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</span> ${item.options?.[item.correct] || item.correct}
            </p>
          ` : ''}
        `;
        quizContainer.appendChild(box);
      });
    }

    function downloadCertificate() {
      const certificateBox = document.getElementById("certificateBox");
      const originalWidth = certificateBox.style.width;
      const originalHeight = certificateBox.style.height;
      
      certificateBox.style.width = "1000px";
      certificateBox.style.height = "700px";
      
      html2canvas(certificateBox, {
        scale: 2,
        logging: false,
        useCORS: true,
        allowTaint: true,
        backgroundColor: null
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = `Ø´Ù‡Ø§Ø¯Ø©_${student.fullName || 'Ø·Ø§Ù„Ø¨'}_${quizId}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        certificateBox.style.width = originalWidth;
        certificateBox.style.height = originalHeight;
      });
    }
  </script>
</body>
</html>
