<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بدء الاختبار | المنصة التعليمية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .certificate-bg {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .certificate-border {
      border: 15px solid transparent;
      border-image: linear-gradient(45deg, #4f46e5, #10b981);
      border-image-slice: 1;
    }
    .gold-text {
      background: linear-gradient(to right, #D4AF37, #F9D423);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-indigo-700 mb-2 text-center">📝 اختبار</h1>
    <p id="timer" class="text-right text-red-600 font-bold mb-4 text-lg">تحميل المؤقت...</p>
    <div id="quizContainer" class="space-y-6"></div>
    <button id="submitBtn" class="mt-6 w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 font-bold text-lg shadow-md transition-all duration-300 transform hover:scale-[1.01]">إنهاء وإرسال</button>
    <p id="resultMsg" class="text-center font-bold text-green-600 mt-6 hidden text-xl"></p>

    <!-- الشهادة المحسنة -->
    <div id="certificateBox" class="hidden mt-8 p-8 rounded-xl shadow-2xl text-center relative overflow-hidden certificate-border certificate-bg">
      <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600"></div>
      <div class="absolute bottom-0 right-0 w-32 h-32 opacity-20">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <path fill="#4F46E5" d="M45.5,-45.5C58.2,-32.8,67.2,-16.4,66.7,-0.6C66.2,15.2,56.2,30.4,43.5,43.5C30.4,56.2,15.2,66.2,-0.6,66.7C-16.4,67.2,-32.8,58.2,-45.5,45.5C-58.2,32.8,-67.2,16.4,-66.7,0.6C-66.2,-15.2,-56.2,-30.4,-43.5,-43.5C-30.4,-56.2,-15.2,-66.2,0.6,-66.7C16.4,-67.2,32.8,-58.2,45.5,-45.5Z" transform="translate(100 100)" />
        </svg>
      </div>
      
      <div class="relative z-10">
        <h2 class="text-4xl font-black mb-6 gold-text">شهادة إتمام اختبار</h2>
        
        <div class="my-6">
          <p class="text-3xl font-bold text-indigo-800 mb-1" id="certStudentName"></p>
          <p class="text-xl text-gray-700">قد أتم بنجاح</p>
        </div>
        
        <div class="bg-white p-4 rounded-lg shadow-inner my-6 mx-auto max-w-md">
          <p class="text-2xl font-bold text-gray-800 mb-2">اختبار: <span id="certQuizName" class="text-indigo-600"></span></p>
          <p class="text-xl font-bold text-gray-800">النتيجة: <span id="certScore" class="text-green-600"></span>%</p>
        </div>
        
        <div class="flex justify-center space-x-8 mt-8">
          <div class="text-center">
            <p class="text-gray-600">التاريخ</p>
            <p class="text-lg font-semibold text-gray-800" id="certDate"></p>
          </div>
        </div>
        
        <div class="mt-10 flex justify-center space-x-4">
          <button onclick="downloadCertificate()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 px-6 rounded-lg hover:from-green-600 hover:to-emerald-700 font-bold shadow-lg transition-all duration-300 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            تحميل الشهادة
          </button>
        </div>
      </div>
      
      <div class="absolute bottom-4 left-4 opacity-30">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4F46E5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
      </div>
      
      <div class="absolute bottom-4 right-4 text-xs text-gray-500">
        <p>منصة التعلم الذكي</p>
      </div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const quizId = params.get("id");
    const quizContainer = document.getElementById("quizContainer");
    const submitBtn = document.getElementById("submitBtn");
    const resultMsg = document.getElementById("resultMsg");
    const timerElement = document.getElementById("timer");

    let currentUser, correctAnswers = 0, totalQuestions = 0, student;

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;

      const userDoc = await db.collection("students").doc(user.uid).get();
      if (!userDoc.exists) return alert("حساب غير صالح");
      student = userDoc.data();

      const resultDoc = await db.collection("students").doc(user.uid).collection("quizResults").doc(quizId).get();
      if (resultDoc.exists) {
        const resultData = resultDoc.data();
        const score = resultData.score;
        const date = resultData.date?.toDate().toLocaleDateString("ar-EG") || "غير محدد";

        resultMsg.innerHTML = `✅ لقد قمت بحل هذا الاختبار سابقًا.<br>النتيجة: <span class="text-2xl">${score}%</span><br>التاريخ: ${date}`;
        resultMsg.classList.remove("hidden");

        document.getElementById("certStudentName").textContent = student.fullName || 'طالب مجهول';
        document.getElementById("certQuizName").textContent = quizId;
        document.getElementById("certScore").textContent = score;
        document.getElementById("certDate").textContent = date;
        document.getElementById("certificateBox").classList.remove("hidden");
      }

      const questionsSnap = await db.collection("quizzes").doc(quizId).collection("questions").get();
      if (questionsSnap.empty) {
        quizContainer.innerHTML = `<p class="text-center text-gray-500 text-xl">لا يوجد أسئلة حالياً.</p>`;
        submitBtn.style.display = "none";
        return;
      }

      totalQuestions = questionsSnap.size;

      questionsSnap.forEach((doc, idx) => {
        const q = doc.data();
        const box = document.createElement("div");
        box.className = "border-2 border-gray-200 p-6 rounded-xl bg-gradient-to-br from-gray-50 to-white shadow-sm hover:shadow-md transition-all duration-300";

        let imgHTML = q.imageURL ? `<img src="${q.imageURL}" class="w-full max-w-md mb-4 rounded-lg border-2 border-gray-200 mx-auto" />` : "";

        box.innerHTML = `
          ${imgHTML}
          <h2 class="font-bold text-xl mb-4 text-indigo-800">${idx + 1}. ${q.question}</h2>
          <div class="space-y-3">
            ${['A', 'B', 'C', 'D'].map(opt => `
              <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 cursor-pointer transition-colors duration-200">
                <input type="radio" name="q${doc.id}" value="${opt}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500">
                <span class="mr-3 text-gray-800">${q.options?.[opt] || ""}</span>
              </label>
            `).join('')}
          </div>
        `;
        quizContainer.appendChild(box);
      });

      startTimer();
    });

    function startTimer() {
      const duration = 3 * 60 * 60 * 1000;
      const endTime = Date.now() + duration;

      const interval = setInterval(() => {
        const remaining = endTime - Date.now();

        if (remaining <= 0) {
          clearInterval(interval);
          timerElement.textContent = "انتهى الوقت! سيتم إرسال الاختبار تلقائياً.";
          submitQuiz();
          return;
        }

        const h = Math.floor(remaining / (1000 * 60 * 60));
        const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((remaining % (1000 * 60)) / 1000);

        timerElement.textContent = `⏳ الوقت المتبقي: ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }, 1000);
    }

    submitBtn.addEventListener("click", () => submitQuiz());

    async function submitQuiz() {
      const questionsSnap = await db.collection("quizzes").doc(quizId).collection("questions").get();
      correctAnswers = 0;

      const answersList = [];

      questionsSnap.forEach(doc => {
        const q = doc.data();
        const selected = document.querySelector(`input[name="q${doc.id}"]:checked`);
        const selectedValue = selected?.value || "لم يجب";
        const correctAnswer = q.correct;

        if (selectedValue === correctAnswer) correctAnswers++;

        answersList.push({
          question: q.question,
          correct: correctAnswer,
          selected: selectedValue,
          options: q.options
        });
      });

      const score = Math.round((correctAnswers / totalQuestions) * 100);

      await db.collection("students").doc(currentUser.uid).collection("quizResults").doc(quizId).set({
        score,
        date: firebase.firestore.FieldValue.serverTimestamp()
      });

      resultMsg.innerHTML = `🎉 تم إنهاء الاختبار بنجاح<br>نتيجتك: <span class="text-3xl ${score >= 50 ? 'text-green-600' : 'text-red-600'}">${score}%</span>`;
      resultMsg.classList.remove("hidden");
      submitBtn.disabled = true;

      document.getElementById("certStudentName").textContent = student.fullName || 'طالب مجهول';
      document.getElementById("certQuizName").textContent = quizId;
      document.getElementById("certScore").textContent = score;
      document.getElementById("certDate").textContent = new Date().toLocaleDateString("ar-EG");
      document.getElementById("certificateBox").classList.remove("hidden");

      quizContainer.innerHTML = "";
      answersList.forEach((item, i) => {
        const box = document.createElement("div");
        box.className = `border-2 ${item.selected === item.correct ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'} p-4 rounded-xl mb-4`;
        box.innerHTML = `
          <h3 class="font-bold text-lg text-gray-800">${i + 1}. ${item.question}</h3>
          <p class="mt-2 ${item.selected === item.correct ? 'text-green-700' : 'text-red-700'}">
            <span class="font-bold">إجابتك:</span> ${item.options?.[item.selected] || item.selected}
          </p>
          ${item.selected !== item.correct ? `
            <p class="text-green-700">
              <span class="font-bold">الإجابة الصحيحة:</span> ${item.options?.[item.correct] || item.correct}
            </p>
          ` : ''}
        `;
        quizContainer.appendChild(box);
      });
    }

    function downloadCertificate() {
      const certificateBox = document.getElementById("certificateBox");
      certificateBox.style.width = "800px";
      certificateBox.style.height = "600px";
      
      html2canvas(certificateBox, {
        scale: 2,
        logging: false,
        useCORS: true,
        allowTaint: true
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = `شهادة-${quizId}-${student.fullName || 'طالب'}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
        
        // Reset dimensions
        certificateBox.style.width = "";
        certificateBox.style.height = "";
      });
    }
  </script>
</body>
</html>
