<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .current-question { background-color: #e0f2fe; }
    .answered { border-right: 5px solid green; }
    .unanswered { border-right: 5px solid red; }
  </style>
</head>
<body class="bg-gray-100">

<!-- Header -->
<div class="bg-white shadow p-4 flex items-center justify-between sticky top-0 z-50">
  <img src="https://i.imgur.com/8Km9tLL.png" alt="Logo" class="h-10">
  <span id="coinsCount" class="text-indigo-700 font-bold cursor-pointer">ğŸ’° 0</span>
</div>

<!-- Quiz Container -->
<div class="max-w-4xl mx-auto bg-white mt-6 p-6 rounded-xl shadow">
  <h1 class="text-2xl font-bold text-indigo-700 mb-2">ğŸ“ Ø§Ø®ØªØ¨Ø§Ø±</h1>
  <p id="timer" class="text-right text-red-600 font-bold mb-4">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª...</p>

  <div class="grid grid-cols-6 gap-2 mb-4" id="questionNumbers"></div>
  <div id="quizContainer" class="space-y-6"></div>

  <div class="flex justify-between mt-6">
    <button id="prevBtn" class="bg-gray-300 px-4 py-2 rounded">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    <button id="submitBtn" class="bg-red-600 text-white px-4 py-2 rounded">Ø¥Ø±Ø³Ø§Ù„</button>
    <button id="nextBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>

  <p id="resultMsg" class="text-center font-bold text-green-600 mt-6 hidden"></p>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
  authDomain: "hhhhhh-d4fb8.firebaseapp.com",
  projectId: "hhhhhh-d4fb8"
});

const auth = firebase.auth();
const db = firebase.firestore();

const quizId = new URLSearchParams(location.search).get("id");
const quizContainer = document.getElementById("quizContainer");
const submitBtn = document.getElementById("submitBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const resultMsg = document.getElementById("resultMsg");
const timerElement = document.getElementById("timer");
const questionNumbers = document.getElementById("questionNumbers");
const coinsCount = document.getElementById("coinsCount");

let questions = [], currentIndex = 0, currentUser = null, studentData = null;

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "index.html";
  currentUser = user;

  const studentRef = await db.collection("students").doc(user.uid).get();
  if (!studentRef.exists) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨.");
  studentData = studentRef.data();

  coinsCount.textContent = `ğŸ’° ${studentData.coins || 0}`;
  coinsCount.onclick = () => location.href = "wallet.html";

  const quizRef = await db.collection("quizzes").doc(quizId).get();
  if (!quizRef.exists) return alert("Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

  const lectureId = quizRef.data().lectureId;
  const lectureSnap = await db.collection("lectures").doc(lectureId).get();
  const courseId = lectureSnap.data().courseId;

  if (!studentData.enrolledCourses?.includes(courseId)) {
    return alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³.");
  }

  const qSnap = await db.collection("quizzes").doc(quizId).collection("questions").get();
  if (qSnap.empty) {
    quizContainer.innerHTML = "<p class='text-center text-gray-500'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
    submitBtn.style.display = "none";
    return;
  }

  questions = shuffleArray(qSnap.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  })));

  renderQuestion(currentIndex);
  renderNumbers();
  startTimer();
});

function renderNumbers() {
  questionNumbers.innerHTML = questions.map((_, i) => `
    <button onclick="goTo(${i})" id="qnum${i}" class="p-2 rounded text-sm bg-gray-100"> ${i + 1} </button>
  `).join('');
}

function renderQuestion(i) {
  const q = questions[i];
  const options = shuffleArray(Object.entries(q.options || {}));

  quizContainer.innerHTML = `
    <div class="border p-4 rounded-lg bg-gray-50">
      ${q.imageURL ? `<img src="${q.imageURL}" class="w-40 mb-2 rounded border" />` : ""}
      <h2 class="font-bold text-lg mb-2">${i + 1}. ${q.question}</h2>
      <div class="space-y-2">
        ${options.map(([key, val]) => `
          <label class="block">
            <input type="radio" name="q${q.id}" value="${key}" class="mr-2"> ${val}
          </label>
        `).join('')}
      </div>
    </div>
  `;

  document.querySelectorAll('#questionNumbers button').forEach((btn, idx) => {
    btn.classList.remove("current-question", "answered", "unanswered");
    const selected = document.querySelector(`input[name="q${questions[idx].id}"]:checked`);
    if (selected) btn.classList.add("answered");
    else btn.classList.add("unanswered");
    if (idx === i) btn.classList.add("current-question");
  });
}

function goTo(i) {
  currentIndex = i;
  renderQuestion(i);
}

prevBtn.onclick = () => {
  if (currentIndex > 0) {
    currentIndex--;
    renderQuestion(currentIndex);
  }
};

nextBtn.onclick = () => {
  if (currentIndex < questions.length - 1) {
    currentIndex++;
    renderQuestion(currentIndex);
  }
};

submitBtn.onclick = async () => {
  let correct = 0;
  const resultDetails = [];

  questions.forEach(q => {
    const selected = document.querySelector(`input[name="q${q.id}"]:checked`)?.value;
    const isCorrect = selected === q.correct;
    if (isCorrect) correct++;

    resultDetails.push({
      question: q.question,
      selected: selected || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
      correct: q.correct
    });
  });

  const score = Math.round((correct / questions.length) * 100);

  await db.collection("students").doc(currentUser.uid).collection("quizResults").doc(quizId).set({
    score,
    date: firebase.firestore.FieldValue.serverTimestamp()
  });

  resultMsg.innerHTML = `âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ù†ØªÙŠØ¬ØªÙƒ: ${score}%`;
  resultMsg.classList.remove("hidden");
  submitBtn.disabled = true;
  prevBtn.disabled = true;
  nextBtn.disabled = true;

  quizContainer.innerHTML = "";
  resultDetails.forEach((q, i) => {
    const box = document.createElement("div");
    box.className = "border p-4 mb-3 rounded bg-gray-50";
    box.innerHTML = `
      <h3 class="font-bold">${i + 1}. ${q.question}</h3>
      <p class="text-sm">Ø¥Ø¬Ø§Ø¨ØªÙƒ: <span class="${q.selected === q.correct ? 'text-green-600' : 'text-red-600'}">${q.selected}</span></p>
      <p class="text-sm">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <span class="text-green-600">${q.correct}</span></p>
    `;
    quizContainer.appendChild(box);
  });
};

function startTimer() {
  const duration = 3 * 60 * 60 * 1000;
  const end = Date.now() + duration;

  const interval = setInterval(() => {
    const left = end - Date.now();
    if (left <= 0) {
      clearInterval(interval);
      timerElement.textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.";
      submitBtn.click();
    } else {
      const h = Math.floor(left / 3600000);
      const m = Math.floor((left % 3600000) / 60000);
      const s = Math.floor((left % 60000) / 1000);
      timerElement.textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }
  }, 1000);
}
</script>
</body>
</html>
