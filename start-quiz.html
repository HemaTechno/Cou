<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بدء الاختبار | المنصة التعليمية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>body { font-family: 'Tajawal', sans-serif; }</style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow">
    <div class="flex justify-between items-center mb-4">
      <img src="logo.png" alt="شعار" class="h-12">
      <div class="cursor-pointer text-indigo-600 font-bold" id="coinsDisplay">💰 تحميل...</div>
    </div>
    <h1 class="text-2xl font-bold text-indigo-700 mb-2">📝 اختبار</h1>
    <p id="timer" class="text-right text-red-600 font-bold mb-4">تحميل المؤقت...</p>
    <div id="questionBox" class="space-y-6"></div>
    <div class="flex justify-between mt-6">
      <button id="prevBtn" class="bg-gray-300 px-4 py-2 rounded">السابق</button>
      <button id="nextBtn" class="bg-gray-300 px-4 py-2 rounded">التالي</button>
    </div>
    <button id="submitBtn" class="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700">إنهاء وإرسال</button>
    <p id="resultMsg" class="text-center font-bold text-green-600 mt-6 hidden"></p>
    <div id="answersReview" class="mt-8 space-y-4"></div>
  </div>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8"
    });
    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const quizId = params.get("id");

    const questionBox = document.getElementById("questionBox");
    const submitBtn = document.getElementById("submitBtn");
    const resultMsg = document.getElementById("resultMsg");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const answersReview = document.getElementById("answersReview");

    let currentUser, student, questions = [], currentIndex = 0, answers = {}, totalQuestions = 0;

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;

      const userDoc = await db.collection("students").doc(user.uid).get();
      if (!userDoc.exists) return alert("حساب غير صالح");
      student = userDoc.data();

      coinsDisplay.textContent = `💰 ${student.coins || 0} كوين`;
      coinsDisplay.onclick = () => window.location.href = "wallet.html";

      const snap = await db.collection("quizzes").doc(quizId).collection("questions").get();
      if (snap.empty) {
        questionBox.innerHTML = '<p class="text-center text-red-600">لا يوجد أسئلة.</p>';
        return;
      }

      snap.forEach(doc => {
        questions.push({ id: doc.id, ...doc.data() });
      });
      totalQuestions = questions.length;
      showQuestion(currentIndex);
      startTimer();
    });

    function showQuestion(index) {
      const q = questions[index];
      let optionsHTML = ['A','B','C','D'].map(opt => `
        <label class="block">
          <input type="radio" name="answer" value="${opt}" ${answers[q.id] === opt ? 'checked' : ''} class="mr-2">
          ${q.options?.[opt] || ''}
        </label>
      `).join('');
      questionBox.innerHTML = `
        <div class="border p-4 rounded bg-gray-50">
          <h2 class="font-bold text-lg mb-2">${index + 1}. ${q.question}</h2>
          ${q.imageURL ? `<img src="${q.imageURL}" class="w-40 mb-2 rounded" />` : ''}
          <div>${optionsHTML}</div>
        </div>
        <div class="flex justify-center space-x-2 mt-4">
          ${questions.map((_, i) => `
            <div class="w-8 h-8 rounded-full flex items-center justify-center cursor-pointer ${answers[questions[i].id] ? 'bg-green-300' : 'bg-red-200'} ${i === currentIndex ? 'border-2 border-indigo-600' : ''}"
              onclick="gotoQuestion(${i})">${i + 1}</div>
          `).join('')}
        </div>
      `;
    }

    function gotoQuestion(i) {
      saveCurrentAnswer();
      currentIndex = i;
      showQuestion(i);
    }

    function saveCurrentAnswer() {
      const selected = document.querySelector('input[name="answer"]:checked');
      if (selected) answers[questions[currentIndex].id] = selected.value;
    }

    prevBtn.onclick = () => {
      saveCurrentAnswer();
      if (currentIndex > 0) currentIndex--;
      showQuestion(currentIndex);
    }

    nextBtn.onclick = () => {
      saveCurrentAnswer();
      if (currentIndex < questions.length - 1) currentIndex++;
      showQuestion(currentIndex);
    }

    submitBtn.onclick = async () => {
      saveCurrentAnswer();
      let correct = 0;
      const reviewList = [];

      questions.forEach(q => {
        const ans = answers[q.id] || 'لم يجب';
        const isCorrect = ans === q.correct;
        if (isCorrect) correct++;
        reviewList.push({ ...q, selected: ans, isCorrect });
      });

      const score = Math.round((correct / totalQuestions) * 100);
      await db.collection("students").doc(currentUser.uid).collection("quizResults").doc(quizId).set({
        score,
        date: firebase.firestore.FieldValue.serverTimestamp()
      });

      resultMsg.textContent = `✅ نتيجتك: ${score}%`;
      resultMsg.classList.remove("hidden");
      submitBtn.disabled = true;

      answersReview.innerHTML = reviewList.map((item, i) => `
        <div class="border p-4 rounded ${item.isCorrect ? 'bg-green-50' : 'bg-red-50'}">
          <p><strong>${i + 1}. ${item.question}</strong></p>
          <p>إجابتك: <span class="${item.isCorrect ? 'text-green-600' : 'text-red-600'}">${item.selected}</span></p>
          <p>الصحيحة: <span class="text-green-600">${item.correct}</span></p>
        </div>`).join('');
    }

    function startTimer() {
      const duration = 3 * 60 * 60 * 1000;
      const endTime = Date.now() + duration;
      const timerElement = document.getElementById("timer");
      const interval = setInterval(() => {
        const remaining = endTime - Date.now();
        if (remaining <= 0) {
          clearInterval(interval);
          timerElement.textContent = "انتهى الوقت! سيتم إرسال الاختبار تلقائياً.";
          submitBtn.click();
          return;
        }
        const h = Math.floor(remaining / (1000 * 60 * 60));
        const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((remaining % (1000 * 60)) / 1000);
        timerElement.textContent = `الوقت المتبقي: ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }, 1000);
    }
  </script>
</body>
</html>
